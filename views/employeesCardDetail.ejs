<%- include('header') %>
<div class="container-fluid d-flex align-items-center justify-content-center" style="font-size:0.9em; min-height:calc(100vh - 200px); padding-top:2rem; padding-bottom:2rem;">
  <% if (typeof message !== 'undefined' && message) { %>
    <div class="alert alert-success alert-dismissible fade show position-absolute" style="top:10px; z-index:1000;">
      <%= message %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% } %>
  <div class="row justify-content-center align-items-center w-100">
    <div class="col-12 d-flex justify-content-center">
      <div class="card shadow-lg border-0" style="max-width:1200px; width:100%; min-height:600px;">
        <div class="row g-0 h-100">
          <div class="col-md-3 d-flex flex-column align-items-center justify-content-center bg-light p-3">
            <% if (employee.profileImage) { %>
              <img src="<%= employee.profileImage %>" class="rounded-circle border border-2 mb-2" alt="프로필 사진" width="200" height="200">
            <% } else { %>
              <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mb-2" style="width:200px;height:200px;">
                <i class="fa-solid fa-user fa-4x text-white"></i>
              </div>
            <% } %>
            <h5 class="fw-bold mb-1"><%= employee.name %></h5>
            <div class="text-muted mb-1">(<%= employee.position || '-' %>)</div>
            <span class="badge bg-primary mb-2"><%= employee.department || '-' %></span>
            <% 
              let statusBadgeClass = 'bg-success';
              let statusText = employee.status || '재직';
              if (statusText === '퇴직') {
                statusBadgeClass = 'bg-danger';
              } else if (statusText === '휴직') {
                statusBadgeClass = 'bg-warning';
              }
            %>
            <span class="badge <%= statusBadgeClass %> mb-2">상태: <%= statusText %></span>
            <div class="mb-1 text-muted small">사번: <%= employee.empNo || '-' %></div>
            <div class="mb-1 text-muted small">이메일: <%= employee.email %></div>
            <div class="mb-1 text-muted small">소속: <%= employee.orgType || '-' %></div>
          </div>
          <div class="col-md-9">
            <div class="card-body p-3 d-flex flex-column h-100">
              <h4 class="card-title mb-3 border-bottom pb-2">상세정보</h4>
              <div class="flex-grow-1">
                <div class="row h-100">
                  <div class="col-md-6">
                    <h6 class="fw-bold text-primary mb-2">개인정보</h6>
                    <div class="row g-0 mb-2 border-bottom pb-2">
                      <div class="col-12 mb-1"><span class="fw-semibold">주민등록번호</span>: <%= employee.residentNumber || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">국적</span>: <%= employee.nationality || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">성별</span>: <%= employee.gender || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">생일</span>: <%= employee.birth && employee.birth.toISOString ? employee.birth.toISOString().slice(0,10) : (employee.birth || '-') %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">혈액형</span>: <%= employee.bloodType || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">신장(cm)</span>: <%= employee.height || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">체중(kg)</span>: <%= employee.weight || '-' %></div>
                    </div>
                    <h6 class="fw-bold text-success mb-2">연락처</h6>
                    <div class="row g-0 mb-2 border-bottom pb-2">
                      <div class="col-6 mb-1"><span class="fw-semibold">연락처</span>: <%= employee.phone || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">핸드폰</span>: <%= employee.mobile || '-' %></div>
                      <div class="col-12 mb-1"><span class="fw-semibold">주소</span>: <%= employee.address || '-' %></div>
                      <div class="col-12 mb-1"><span class="fw-semibold">비상연락처</span>: <%= employee.emergencyContact || '-' %></div>
                    </div>
                    <h6 class="fw-bold text-danger mb-2">병역사항</h6>
                    <div class="row g-0 mb-2 border-bottom pb-2">
                      <div class="col-6 mb-1"><span class="fw-semibold">군별</span>: <%= employee.militaryBranch || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">계급</span>: <%= employee.militaryRank || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">군번</span>: <%= employee.militaryNumber || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">복무기간</span>: <%= employee.militaryServicePeriod || '-' %></div>
                      <div class="col-12 mb-1"><span class="fw-semibold">미필사유</span>: <%= employee.militaryExemptionReason || '-' %></div>
                    </div>
                    <h6 class="fw-bold text-warning mb-2">고용정보</h6>
                    <div class="row g-0 mb-2 border-bottom pb-2">
                      <div class="col-6 mb-1"><span class="fw-semibold">채용구분</span>: <%= employee.employmentType || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">입사날짜</span>: <%= employee.hireDate && employee.hireDate.toISOString ? employee.hireDate.toISOString().slice(0,10) : (employee.hireDate || '-') %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">상태</span>: <%= employee.status || '재직' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">급여은행</span>: <%= employee.salaryBank || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">급여계좌</span>: <%= employee.salaryAccount || '-' %></div>
                    </div>
                    <h6 class="fw-bold text-secondary mb-2">특이사항</h6>
                    <div class="row g-0 mb-2 border-bottom pb-2">
                      <div class="col-12 mb-1"><span class="fw-semibold">특이사항</span>: <%= employee.specialNotes || '-' %></div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <h6 class="fw-bold text-primary mb-2">학력사항</h6>
                    <div class="row g-0 mb-2 border-bottom pb-2">
                      <div class="col-12 mb-1"><span class="fw-semibold">학력</span>: <%= employee.education || '-' %></div>
                    </div>
                    <h6 class="fw-bold text-primary mb-2">경력사항</h6>
                    <div class="row g-0 mb-2 border-bottom pb-2">
                      <div class="col-12 mb-1"><span class="fw-semibold">경력</span>: <%= employee.career || '-' %></div>
                    </div>
                    <h6 class="fw-bold text-info mb-2">유니폼/장구류</h6>
                    <div class="row g-0">
                      <div class="col-6 mb-1"><span class="fw-semibold">모자</span>: <%= employee.cap || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">하복상의</span>: <%= employee.uniformSummerTop || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">하복하의</span>: <%= employee.uniformSummerBottom || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">동복상의</span>: <%= employee.uniformWinterTop || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">동복하의</span>: <%= employee.uniformWinterBottom || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">춘추복</span>: <%= employee.springAutumnUniform || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">방한외투</span>: <%= employee.uniformWinterCoat || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">우의</span>: <%= employee.raincoat || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">신발(안전화)</span>: <%= employee.safetyShoes || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">장화</span>: <%= employee.rainBoots || '-' %></div>
                      <div class="col-6 mb-1"><span class="fw-semibold">동점퍼</span>: <%= employee.winterJacket || '-' %></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
.fab-group {
  position: fixed;
  right: 32px;
  bottom: 32px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.fab-btn {
  border-radius: 50%;
  width: 56px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  border: none;
}
.toast {
  position: fixed;
  bottom: 100px;
  right: 40px;
  z-index: 99999;
  background: #222;
  color: #fff;
  padding: 12px 24px;
  border-radius: 8px;
  opacity: 0.95;
  font-size: 1rem;
  display: none;
}
</style>
<div class="fab-group">
  <a href="/employees" class="btn btn-info fab-btn" title="목록으로"><i class="fa-solid fa-list"></i></a>
</div>
<div id="toast" class="toast"></div>
<script>
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(()=>{ t.style.display = 'none'; }, 1800);
}
function editFieldTyped(field, value, type, options) {
  const span = document.getElementById(field+'-value');
  if (!span) return;
  let input;
  if (type === 'select') {
    input = document.createElement('select');
    input.className = 'form-select form-select-sm d-inline w-auto';
    (options||[]).forEach(opt => {
      const o = document.createElement('option');
      o.value = opt; o.textContent = opt;
      if (value === opt) o.selected = true;
      input.appendChild(o);
    });
  } else if (type === 'date') {
    input = document.createElement('input');
    input.type = 'date';
    input.className = 'form-control form-control-sm d-inline w-auto';
    input.value = value && value !== '-' ? value : '';
  } else if (type === 'number') {
    input = document.createElement('input');
    input.type = 'number';
    input.className = 'form-control form-control-sm d-inline w-auto';
    input.value = value && value !== '-' ? value : '';
  } else if (type === 'textarea') {
    input = document.createElement('textarea');
    input.className = 'form-control form-control-sm d-inline w-auto';
    input.value = value && value !== '-' ? value : '';
    input.rows = 2;
    input.style.minWidth = '120px';
  } else {
    input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control form-control-sm d-inline w-auto';
    input.value = value && value !== '-' ? value : '';
  }
  input.style.maxWidth = '180px';
  const saveBtn = document.createElement('button');
  saveBtn.textContent = '저장';
  saveBtn.className = 'btn btn-sm btn-primary ms-1';
  saveBtn.onclick = function(e) { e.preventDefault(); saveField(field, input.value); };
  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = '취소';
  cancelBtn.className = 'btn btn-sm btn-secondary ms-1';
  cancelBtn.onclick = function(e) { e.preventDefault(); location.reload(); };
  const wrap = document.createElement('span');
  wrap.appendChild(input);
  wrap.appendChild(saveBtn);
  wrap.appendChild(cancelBtn);
  span.replaceWith(wrap);
  input.focus();
}
function saveField(field, value) {
  fetch(window.location.pathname.replace(/\/$/, '') + '/field', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ field, value })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showToast('저장되었습니다.');
      // 상세카드 페이지를 다시 로드하여 수정된 내용을 즉시 반영
      setTimeout(() => {
        window.location.reload();
      }, 900);
    } else {
      showToast('수정 실패: ' + (data.error || '')); 
      setTimeout(() => {
        window.location.reload();
      }, 1200);
    }
  })
  .catch(error => {
    console.error('필드 수정 오류:', error);
    showToast('수정 중 오류가 발생했습니다.');
    setTimeout(() => {
      window.location.reload();
    }, 1200);
  });
}
function deleteField(field) {
  if (!confirm('정말 삭제하시겠습니까?')) return;
  saveField(field, '');
}
function goFirstEmptyField() {
  const fields = [
    { key: 'nationality', value: '<%= employee.nationality || '' %>', label: '국적' },
    { key: 'ssn', value: '<%= employee.ssn || '' %>', label: '주민등록번호' },
    { key: 'gender', value: '<%= employee.gender || '' %>', label: '성별' },
    { key: 'age', value: '<%= employee.age || '' %>', label: '나이' },
    { key: 'education', value: '<%= employee.education || '' %>', label: '학력' },
    { key: 'employmentType', value: '<%= employee.employmentType || '' %>', label: '채용구분' },
    { key: 'hireDate', value: '<%= employee.hireDate ? employee.hireDate.toISOString().slice(0,10) : '' %>', label: '입사날짜' },
    { key: 'salaryBank', value: '<%= employee.salaryBank || '' %>', label: '급여은행' },
    { key: 'salaryAccount', value: '<%= employee.salaryAccount || '' %>', label: '급여계좌' },
    { key: 'workLocation', value: '<%= employee.workLocation || '' %>', label: '근무위치' },
    { key: 'rewardPunishment', value: '<%= employee.rewardPunishment || '' %>', label: '상벌사항' }
  ];
  const empty = fields.find(f => !f.value || f.value === '-');
  if (empty) {
    alert(empty.label + ' 등록 페이지로 이동합니다.');
    window.location.href = '/admin/employees/<%= employee._id %>/editField/' + empty.key;
  } else {
    window.location.href = '/employees/new';
  }
}
</script>
<div class="fab-group">
  <a href="/employees" class="btn btn-info fab-btn" title="목록으로"><i class="fa-solid fa-list"></i></a>
</div>
<div id="toast" class="toast"></div>
<%- include('footer') %> 