<!--
  파일명: excelManager.ejs
  목적: 통합 엑셀 파일 관리 페이지 (관리자용)
  기능:
  - 직원 정보 엑셀 관리
  - 근무 스케줄 엑셀 관리  
  - 근태 관리 엑셀 관리
  - 보고서 엑셀 다운로드
  - 일괄 데이터 처리
  - 관리자 권한 검증
-->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>통합 엑셀 관리</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .excel-card {
      transition: transform 0.2s, box-shadow 0.2s;
      border: none;
      border-radius: 15px;
      height: 100%;
    }
    .excel-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .upload-area {
      border: 2px dashed #dee2e6;
      border-radius: 15px;
      transition: all 0.3s;
      background: #f8f9fa;
    }
    .upload-area:hover {
      border-color: #0d6efd;
      background: #f0f8ff;
    }
    .upload-area.dragover {
      border-color: #0d6efd;
      background: #e3f2fd;
    }
    .file-preview {
      max-height: 200px;
      overflow-y: auto;
    }
    .progress-bar {
      transition: width 0.3s ease;
    }
    .category-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .template-download {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .data-export {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }
    .data-import {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }
    .btn-excel {
      border-radius: 10px;
      font-weight: 600;
      padding: 12px 24px;
      transition: all 0.3s;
    }
    .btn-excel:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .nav-pills .nav-link {
      border-radius: 25px;
      margin: 0 5px;
      font-weight: 500;
    }
    .nav-pills .nav-link.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
    }
  </style>
</head>
<body class="bg-light">
  <%- include('header') %>
  
  <div class="container mt-4">
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <h1 class="h2 mb-0">
            <i class="fa-solid fa-file-excel me-2 text-success"></i>
            통합 엑셀 관리
          </h1>
        </div>
        <p class="text-muted mt-2">모든 엑셀 관련 기능을 한 곳에서 관리할 수 있습니다.</p>
      </div>
    </div>

    <!-- 알림 메시지 -->
    <% if (typeof message !== 'undefined' && message) { %>
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="fa-solid fa-info-circle me-2"></i>
        <%= message %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>

    <!-- 카테고리 네비게이션 -->
    <ul class="nav nav-pills mb-4 justify-content-center" id="excelTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="employee-tab" data-bs-toggle="pill" data-bs-target="#employee" type="button" role="tab">
          <i class="fa-solid fa-users me-2"></i>직원 관리
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="schedule-tab" data-bs-toggle="pill" data-bs-target="#schedule" type="button" role="tab">
          <i class="fa-solid fa-calendar me-2"></i>근무 스케줄
        </button>
      </li>
             <li class="nav-item" role="presentation">
         <button class="nav-link" id="attendance-tab" data-bs-toggle="pill" data-bs-target="#attendance" type="button" role="tab">
           <i class="fa-solid fa-clock me-2"></i>근태 관리
         </button>
       </li>
       <li class="nav-item" role="presentation">
         <button class="nav-link" id="uniform-tab" data-bs-toggle="pill" data-bs-target="#uniform" type="button" role="tab">
           <i class="fa-solid fa-tshirt me-2"></i>유니폼
         </button>
       </li>
       <li class="nav-item" role="presentation">
         <button class="nav-link" id="logs-tab" data-bs-toggle="pill" data-bs-target="#logs" type="button" role="tab">
           <i class="fa-solid fa-history me-2"></i>로그
         </button>
       </li>
       <li class="nav-item" role="presentation">
         <button class="nav-link" id="reports-tab" data-bs-toggle="pill" data-bs-target="#reports" type="button" role="tab">
           <i class="fa-solid fa-chart-bar me-2"></i>보고서
         </button>
       </li>
    </ul>

    <!-- 탭 콘텐츠 -->
    <div class="tab-content" id="excelTabContent">
      
      <!-- 직원 관리 탭 -->
      <div class="tab-pane fade show active" id="employee" role="tabpanel">
        <div class="category-section">
          <h3 class="mb-3">
            <i class="fa-solid fa-users me-2"></i>
            직원 정보 엑셀 관리
          </h3>
          <p class="mb-0">직원 정보를 엑셀로 다운로드하거나 업로드하여 일괄 처리할 수 있습니다.</p>
      </div>

        <div class="feature-grid">
      <!-- 템플릿 다운로드 -->
          <div class="card excel-card template-download">
            <div class="card-body text-center">
              <i class="fa-solid fa-download fa-3x mb-3"></i>
              <h5 class="card-title">엑셀 템플릿</h5>
              <p class="card-text">직원 정보 입력을 위한 엑셀 템플릿을 다운로드하세요.</p>
              <div class="mt-3">
              <a href="/employees/excel/template" class="btn btn-light btn-excel">
                  <i class="fa-solid fa-download me-2"></i>
                템플릿 다운로드
              </a>
          </div>
        </div>
      </div>

      <!-- 데이터 내보내기 -->
          <div class="card excel-card data-export">
            <div class="card-body text-center">
              <i class="fa-solid fa-file-export fa-3x mb-3"></i>
              <h5 class="card-title">직원 데이터 내보내기</h5>
              <p class="card-text">현재 직원 목록을 엑셀 파일로 다운로드하세요.</p>
              <div class="mt-3">
                <button class="btn btn-light btn-excel" onclick="downloadEmployeeData()">
                <i class="fa-solid fa-download me-2"></i>
                엑셀 다운로드
              </button>
          </div>
        </div>
      </div>

      <!-- 데이터 가져오기 -->
          <div class="card excel-card data-import">
            <div class="card-body text-center">
              <i class="fa-solid fa-file-import fa-3x mb-3"></i>
              <h5 class="card-title">직원 데이터 가져오기</h5>
              <p class="card-text">엑셀 파일을 업로드하여 직원 정보를 일괄 등록하세요.</p>
              <div class="mt-3">
                <button class="btn btn-light btn-excel" onclick="openUploadModal('employee')">
                  <i class="fa-solid fa-upload me-2"></i>
                  파일 업로드
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 근무 스케줄 탭 -->
      <div class="tab-pane fade" id="schedule" role="tabpanel">
        <div class="category-section">
          <h3 class="mb-3">
            <i class="fa-solid fa-calendar me-2"></i>
            근무 스케줄 엑셀 관리
          </h3>
          <p class="mb-0">근무 스케줄을 엑셀로 내보내거나 가져올 수 있습니다.</p>
        </div>
        
        <div class="feature-grid">
          <!-- 스케줄 템플릿 -->
          <div class="card excel-card template-download">
            <div class="card-body text-center">
              <i class="fa-solid fa-download fa-3x mb-3"></i>
              <h5 class="card-title">스케줄 템플릿</h5>
              <p class="card-text">근무 스케줄 입력을 위한 엑셀 템플릿을 다운로드하세요.</p>
              <div class="mt-3">
                <button class="btn btn-light btn-excel" onclick="downloadScheduleTemplate()">
                  <i class="fa-solid fa-download me-2"></i>
                  템플릿 다운로드
                </button>
              </div>
            </div>
          </div>

          <!-- 스케줄 내보내기 -->
          <div class="card excel-card data-export">
            <div class="card-body text-center">
              <i class="fa-solid fa-file-export fa-3x mb-3"></i>
              <h5 class="card-title">스케줄 내보내기</h5>
              <p class="card-text">현재 근무 스케줄을 엑셀 파일로 다운로드하세요.</p>
              <div class="mt-3">
                <button class="btn btn-light btn-excel" onclick="downloadScheduleData()">
                  <i class="fa-solid fa-download me-2"></i>
                  엑셀 다운로드
                </button>
              </div>
            </div>
          </div>

          <!-- 스케줄 가져오기 -->
          <div class="card excel-card data-import">
            <div class="card-body text-center">
              <i class="fa-solid fa-file-import fa-3x mb-3"></i>
              <h5 class="card-title">스케줄 가져오기</h5>
              <p class="card-text">엑셀 파일을 업로드하여 근무 스케줄을 일괄 설정하세요.</p>
              <div class="mt-3">
                <button class="btn btn-light btn-excel" onclick="openUploadModal('schedule')">
                  <i class="fa-solid fa-upload me-2"></i>
                  파일 업로드
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

             <!-- 근태 관리 탭 -->
       <div class="tab-pane fade" id="attendance" role="tabpanel">
         <div class="category-section">
           <h3 class="mb-3">
             <i class="fa-solid fa-clock me-2"></i>
             근태 관리 엑셀 관리
           </h3>
           <p class="mb-0">근태 데이터를 엑셀로 내보내거나 가져올 수 있습니다.</p>
         </div>
         
         <div class="feature-grid">
           <!-- 근태 내보내기 -->
           <div class="card excel-card data-export">
             <div class="card-body text-center">
               <i class="fa-solid fa-file-export fa-3x mb-3"></i>
               <h5 class="card-title">근태 데이터 내보내기</h5>
               <p class="card-text">근태 데이터를 엑셀 파일로 다운로드하세요.</p>
               <div class="mt-3">
                 <button class="btn btn-light btn-excel" onclick="downloadAttendanceData()">
                   <i class="fa-solid fa-download me-2"></i>
                   엑셀 다운로드
                 </button>
               </div>
             </div>
            </div>

           <!-- 근태 가져오기 -->
           <div class="card excel-card data-import">
             <div class="card-body text-center">
               <i class="fa-solid fa-file-import fa-3x mb-3"></i>
               <h5 class="card-title">근태 데이터 가져오기</h5>
               <p class="card-text">엑셀 파일을 업로드하여 근태 데이터를 일괄 입력하세요.</p>
               <div class="mt-3">
                 <button class="btn btn-light btn-excel" onclick="openUploadModal('attendance')">
                <i class="fa-solid fa-upload me-2"></i>
                파일 업로드
              </button>
               </div>
             </div>
           </div>

           <!-- 근태 보고서 -->
           <div class="card excel-card template-download">
             <div class="card-body text-center">
               <i class="fa-solid fa-chart-line fa-3x mb-3"></i>
               <h5 class="card-title">근태 보고서</h5>
               <p class="card-text">월별/분기별 근태 보고서를 엑셀로 다운로드하세요.</p>
               <div class="mt-3">
                 <button class="btn btn-light btn-excel" onclick="downloadAttendanceReport()">
                   <i class="fa-solid fa-download me-2"></i>
                   보고서 다운로드
                 </button>
            </div>
          </div>
        </div>
      </div>
    </div>

       <!-- 유니폼 관리 탭 -->
       <div class="tab-pane fade" id="uniform" role="tabpanel">
         <div class="category-section">
           <h3 class="mb-3">
             <i class="fa-solid fa-tshirt me-2"></i>
             유니폼 관리 엑셀 관리
           </h3>
           <p class="mb-0">유니폼 현황 및 통계를 엑셀로 관리할 수 있습니다.</p>
         </div>
         
         <div class="feature-grid">


           <!-- 유니폼 데이터 가져오기 -->
           <div class="card excel-card data-import">
             <div class="card-body text-center">
               <i class="fa-solid fa-file-import fa-3x mb-3"></i>
               <h5 class="card-title">유니폼 데이터 가져오기</h5>
               <p class="card-text">엑셀 파일을 업로드하여 유니폼 데이터를 일괄 설정하세요.</p>
               <div class="mt-3">
                 <button class="btn btn-light btn-excel" onclick="openUploadModal('uniform')">
                   <i class="fa-solid fa-upload me-2"></i>
                   파일 업로드
                 </button>
               </div>
             </div>
          </div>

           <!-- 유니폼 템플릿 -->
           <div class="card excel-card template-download">
             <div class="card-body text-center">
               <i class="fa-solid fa-download fa-3x mb-3"></i>
               <h5 class="card-title">유니폼 템플릿</h5>
               <p class="card-text">유니폼 데이터 입력을 위한 엑셀 템플릿을 다운로드하세요.</p>
               <div class="mt-3">
                 <button class="btn btn-light btn-excel" onclick="downloadUniformTemplate()">
                   <i class="fa-solid fa-download me-2"></i>
                  템플릿 다운로드
                 </button>
               </div>
             </div>
           </div>
         </div>
       </div>

       <!-- 로그 관리 탭 -->
       <div class="tab-pane fade" id="logs" role="tabpanel">
         <div class="category-section">
           <h3 class="mb-3">
             <i class="fa-solid fa-history me-2"></i>
             로그 관리 엑셀 관리
           </h3>
           <p class="mb-0">사용자 활동 로그를 엑셀로 관리할 수 있습니다.</p>
         </div>
         
         <div class="feature-grid">
           <!-- 활동 로그 내보내기 -->
           <div class="card excel-card data-export">
             <div class="card-body text-center">
               <i class="fa-solid fa-file-export fa-3x mb-3"></i>
               <h5 class="card-title">활동 로그 내보내기</h5>
               <p class="card-text">사용자 활동 로그를 엑셀 파일로 다운로드하세요.</p>
               <div class="mt-3">
                 <button class="btn btn-light btn-excel" onclick="downloadActivityLogs()">
                   <i class="fa-solid fa-download me-2"></i>
                   엑셀 다운로드
                 </button>
               </div>
             </div>
           </div>

           <!-- 로그 필터 설정 -->
           <div class="card excel-card template-download">
             <div class="card-body text-center">
               <i class="fa-solid fa-filter fa-3x mb-3"></i>
               <h5 class="card-title">로그 필터 설정</h5>
               <p class="card-text">로그 내보내기 전에 필터 조건을 설정하세요.</p>
               <div class="mt-3">
                 <button class="btn btn-light btn-excel" onclick="openLogFilterModal()">
                   <i class="fa-solid fa-cog me-2"></i>
                   필터 설정
                 </button>
               </div>
             </div>
           </div>

           <!-- 로그 통계 보고서 -->
           <div class="card excel-card template-download">
             <div class="card-body text-center">
               <i class="fa-solid fa-chart-bar fa-3x mb-3"></i>
               <h5 class="card-title">로그 통계 보고서</h5>
               <p class="card-text">활동 로그 통계를 엑셀 보고서로 다운로드하세요.</p>
               <div class="mt-3">
                 <button class="btn btn-light btn-excel" onclick="downloadLogReport()">
                   <i class="fa-solid fa-download me-2"></i>
                   보고서 다운로드
                 </button>
               </div>
             </div>
           </div>
         </div>
       </div>

      <!-- 보고서 탭 -->
      <div class="tab-pane fade" id="reports" role="tabpanel">
        <div class="category-section">
          <h3 class="mb-3">
            <i class="fa-solid fa-chart-bar me-2"></i>
            보고서 엑셀 다운로드
          </h3>
          <p class="mb-0">다양한 업무 보고서를 엑셀 형식으로 다운로드할 수 있습니다.</p>
        </div>
        
        <div class="feature-grid">
          <!-- 인사 보고서 -->
          <div class="card excel-card data-export">
            <div class="card-body text-center">
              <i class="fa-solid fa-users-cog fa-3x mb-3"></i>
              <h5 class="card-title">인사 현황 보고서</h5>
              <p class="card-text">직원 현황 및 통계를 포함한 인사 보고서를 다운로드하세요.</p>
              <div class="mt-3">
                <button class="btn btn-light btn-excel" onclick="downloadHRReport()">
                  <i class="fa-solid fa-download me-2"></i>
                  보고서 다운로드
                </button>
              </div>
            </div>
          </div>

          <!-- 근무 통계 -->
          <div class="card excel-card data-export">
            <div class="card-body text-center">
              <i class="fa-solid fa-chart-pie fa-3x mb-3"></i>
              <h5 class="card-title">근무 통계 보고서</h5>
              <p class="card-text">근무 시간, 휴가, 특근 등의 통계 보고서를 다운로드하세요.</p>
              <div class="mt-3">
                <button class="btn btn-light btn-excel" onclick="downloadWorkStatsReport()">
                  <i class="fa-solid fa-download me-2"></i>
                  보고서 다운로드
                </button>
              </div>
              </div>
              </div>

          <!-- 월별 요약 -->
          <div class="card excel-card template-download">
            <div class="card-body text-center">
              <i class="fa-solid fa-calendar-alt fa-3x mb-3"></i>
              <h5 class="card-title">월별 요약 보고서</h5>
              <p class="card-text">월별 인사 및 근무 현황 요약 보고서를 다운로드하세요.</p>
              <div class="mt-3">
                <button class="btn btn-light btn-excel" onclick="downloadMonthlyReport()">
                  <i class="fa-solid fa-download me-2"></i>
                  보고서 다운로드
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 업로드 모달 -->
  <div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-upload me-2"></i>
            엑셀 파일 업로드
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="uploadForm" action="/employees/upload" method="POST" enctype="multipart/form-data">
            <div class="upload-area p-5 text-center" id="uploadArea">
              <i class="fa-solid fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
              <h5>파일을 드래그하거나 클릭하여 선택하세요</h5>
              <p class="text-muted">지원 형식: .xlsx, .csv (최대 10MB)</p>
              <input type="file" id="excelFile" name="excelFile" accept=".xlsx,.csv" class="d-none" required>
              <button type="button" class="btn btn-primary" onclick="document.getElementById('excelFile').click()">
                <i class="fa-solid fa-folder-open me-2"></i>
                파일 선택
              </button>
            </div>
            
            <!-- 파일 미리보기 -->
            <div id="filePreview" class="mt-3" style="display: none;">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">
                    <i class="fa-solid fa-file-excel me-2 text-success"></i>
                    선택된 파일
                  </h6>
                </div>
                <div class="card-body">
                  <div id="fileInfo"></div>
                  <div id="previewContent" class="file-preview mt-3"></div>
                </div>
              </div>
            </div>

            <!-- 업로드 옵션 -->
            <div class="mt-4">
              <h6>업로드 옵션</h6>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="skipHeader" name="skipHeader" checked>
                <label class="form-check-label" for="skipHeader">
                  첫 번째 행을 헤더로 건너뛰기
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="updateExisting" name="updateExisting">
                <label class="form-check-label" for="updateExisting">
                  기존 데이터 업데이트 (이메일 기준)
                </label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" form="uploadForm" class="btn btn-primary" id="uploadBtn" disabled>
            <i class="fa-solid fa-upload me-2"></i>
            업로드 시작
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 진행률 모달 -->
  <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-spinner fa-spin me-2"></i>
            업로드 진행 중...
          </h5>
        </div>
        <div class="modal-body">
          <div class="progress mb-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%" id="uploadProgress"></div>
          </div>
          <p class="text-muted mb-0" id="progressText">파일을 처리하고 있습니다...</p>
        </div>
      </div>
    </div>
  </div>

     <%- include('footer') %>

   <script>
    // 직원 엑셀 다운로드
    function downloadEmployeeExcel() {
      window.location.href = '/employees/excel?format=xlsx';
    }

    // 근무 스케줄 템플릿 다운로드
    function downloadScheduleTemplate() {
      window.location.href = '/workSchedule/excel/template';
    }

    // 근무 스케줄 엑셀 다운로드
    function downloadScheduleExcel() {
      window.location.href = '/workSchedule/excel?format=xlsx';
    }

    // 근태 데이터 엑셀 다운로드
    function downloadAttendanceExcel() {
      window.location.href = '/attendance/excel?format=xlsx';
    }

    // 근태 보고서 다운로드
    function downloadAttendanceReport() {
      const month = prompt('보고서를 생성할 월을 입력하세요 (예: 2025-08):', new Date().toISOString().slice(0, 7));
      if (month) {
        window.location.href = `/attendance/report/excel?month=${month}`;
      }
    }

    // 인사 보고서 다운로드
    function downloadHRReport() {
      window.location.href = '/employees/report/excel';
    }

    // 근무 통계 보고서 다운로드
    function downloadWorkStatsReport() {
      const month = prompt('통계 보고서를 생성할 월을 입력하세요 (예: 2025-08):', new Date().toISOString().slice(0, 7));
      if (month) {
        window.location.href = `/workSchedule/stats/excel?month=${month}`;
      }
    }

         // 월별 요약 보고서 다운로드
     function downloadMonthlyReport() {
       const month = prompt('요약 보고서를 생성할 월을 입력하세요 (예: 2025-08):', new Date().toISOString().slice(0, 7));
       if (month) {
         window.location.href = `/dashboard/monthly-report/excel?month=${month}`;
       }
     }



     // 유니폼 템플릿 다운로드
     function downloadUniformTemplate() {
       window.location.href = '/uniform/excel/template';
     }

     // 활동 로그 다운로드
     function downloadActivityLogs() {
       window.location.href = '/auth/logs/excel';
     }

     // 로그 통계 보고서 다운로드
     function downloadLogReport() {
       const month = prompt('로그 보고서를 생성할 월을 입력하세요 (예: 2025-08):', new Date().toISOString().slice(0, 7));
       if (month) {
         window.location.href = `/auth/logs/report/excel?month=${month}`;
       }
     }

     // 로그 필터 모달 열기
     function openLogFilterModal() {
       alert('로그 필터 설정 기능은 개발 중입니다.');
    }

    // 업로드 모달 열기
    function openUploadModal(category) {
      const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
      
      // 카테고리에 따른 폼 액션 및 제목 설정
      const form = document.getElementById('uploadForm');
      const modalTitle = document.querySelector('#uploadModal .modal-title');
      
      switch(category) {
        case 'employee':
          form.action = '/employees/upload';
          modalTitle.innerHTML = '<i class="fa-solid fa-users me-2"></i>직원 정보 업로드';
          break;
        case 'schedule':
          form.action = '/workSchedule/upload';
          modalTitle.innerHTML = '<i class="fa-solid fa-calendar me-2"></i>근무 스케줄 업로드';
          break;
                 case 'attendance':
           form.action = '/attendance/upload';
           modalTitle.innerHTML = '<i class="fa-solid fa-clock me-2"></i>근태 데이터 업로드';
           break;
         case 'uniform':
           form.action = '/uniform/upload';
           modalTitle.innerHTML = '<i class="fa-solid fa-tshirt me-2"></i>유니폼 데이터 업로드';
           break;
        default:
          form.action = '/employees/upload';
          modalTitle.innerHTML = '<i class="fa-solid fa-upload me-2"></i>파일 업로드';
      }
      
      modal.show();
    }

    // 파일 선택 처리
    document.getElementById('excelFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const uploadArea = document.getElementById('uploadArea');
      const filePreview = document.getElementById('filePreview');
      const fileInfo = document.getElementById('fileInfo');
      const uploadBtn = document.getElementById('uploadBtn');
      
      if (file) {
      // 파일 정보 표시
      fileInfo.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="fa-solid fa-file-excel text-success me-2"></i>
          <div>
              <strong>${file.name}</strong>
              <br>
              <small class="text-muted">
                크기: ${(file.size / 1024 / 1024).toFixed(2)} MB | 
                형식: ${file.type || '알 수 없음'}
              </small>
          </div>
        </div>
      `;

        // 파일 미리보기 표시
        filePreview.style.display = 'block';
        uploadBtn.disabled = false;
        
        // 업로드 영역 스타일 변경
        uploadArea.style.borderColor = '#28a745';
        uploadArea.style.backgroundColor = '#d4edda';
        uploadArea.innerHTML = `
          <i class="fa-solid fa-check-circle fa-3x text-success mb-3"></i>
          <h5 class="text-success">파일이 선택되었습니다</h5>
          <p class="text-muted">${file.name}</p>
        `;
      } else {
        // 파일 미리보기 숨기기
        filePreview.style.display = 'none';
        uploadBtn.disabled = true;
        
        // 업로드 영역 원래대로 복원
        uploadArea.style.borderColor = '#dee2e6';
        uploadArea.style.backgroundColor = '#f8f9fa';
        uploadArea.innerHTML = `
          <i class="fa-solid fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
          <h5>파일을 드래그하거나 클릭하여 선택하세요</h5>
          <p class="text-muted">지원 형식: .xlsx, .csv (최대 10MB)</p>
          <input type="file" id="excelFile" name="excelFile" accept=".xlsx,.csv" class="d-none" required>
          <button type="button" class="btn btn-primary" onclick="document.getElementById('excelFile').click()">
            <i class="fa-solid fa-folder-open me-2"></i>
            파일 선택
          </button>
        `;
      }
    });

    // 드래그 앤 드롭 기능
    const uploadArea = document.getElementById('uploadArea');
    
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || 
            file.type === 'text/csv' || 
            file.name.endsWith('.xlsx') || 
            file.name.endsWith('.csv')) {
          
          document.getElementById('excelFile').files = files;
          document.getElementById('excelFile').dispatchEvent(new Event('change'));
        } else {
          alert('엑셀 파일(.xlsx) 또는 CSV 파일(.csv)만 업로드 가능합니다.');
        }
      }
    });

    // 폼 제출 처리
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
      const progressBar = document.getElementById('uploadProgress');
      const progressText = document.getElementById('progressText');
      
      // 진행률 모달 표시
      progressModal.show();
      
      // 업로드 진행
      fetch(this.action, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          progressText.textContent = '업로드가 완료되었습니다!';
        progressBar.style.width = '100%';
          progressBar.classList.add('bg-success');
        
        setTimeout(() => {
          progressModal.hide();
            location.reload(); // 페이지 새로고침
          }, 1500);
          } else {
          throw new Error(result.message || '업로드에 실패했습니다.');
          }
      })
      .catch(error => {
        console.error('업로드 오류:', error);
        progressText.textContent = `오류 발생: ${error.message}`;
        progressBar.classList.add('bg-danger');
        
        setTimeout(() => {
        progressModal.hide();
        }, 3000);
      });
    });

    // 탭 전환 시 애니메이션
    document.querySelectorAll('#excelTabs .nav-link').forEach(tab => {
      tab.addEventListener('click', function() {
        // 모든 탭 비활성화
        document.querySelectorAll('#excelTabs .nav-link').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
        
        // 선택된 탭 활성화
        this.classList.add('active');
        const target = document.querySelector(this.getAttribute('data-bs-target'));
        target.classList.add('show', 'active');
      });
    });

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
      console.log('통합 엑셀 관리 페이지가 로드되었습니다.');
      
      // 헤더 드롭다운 메뉴 초기화
      initializeHeaderDropdowns();
    });
    
    // 헤더 드롭다운 메뉴 초기화 함수
    function initializeHeaderDropdowns() {
      try {
        // Bootstrap 드롭다운 초기화
        const dropdownElementList = document.querySelectorAll('.dropdown-toggle');
        const dropdownList = [...dropdownElementList].map(dropdownToggleEl => {
          return new bootstrap.Dropdown(dropdownToggleEl);
        });
        
        console.log('헤더 드롭다운 메뉴 초기화 완료:', dropdownList.length, '개');
        
        // 드롭다운 클릭 이벤트 리스너 추가
        document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
          toggle.addEventListener('click', function(e) {
            e.preventDefault();
            const dropdownMenu = this.nextElementSibling;
            if (dropdownMenu && dropdownMenu.classList.contains('dropdown-menu')) {
              dropdownMenu.classList.toggle('show');
            }
          });
        });
        
        // 드롭다운 외부 클릭 시 닫기
        document.addEventListener('click', function(e) {
          if (!e.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
              menu.classList.remove('show');
            });
          }
        });
        
      } catch (error) {
        console.error('헤더 드롭다운 초기화 오류:', error);
      }
    }

    // 중복 함수 제거됨 - 위쪽에 이미 정의된 함수들 사용
  </script>
</body>
</html> 