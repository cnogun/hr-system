<!--
  파일명: excelManager.ejs
  목적: 엑셀 파일 관리 페이지 (관리자용)
  기능:
  - 엑셀 파일 업로드
  - 엑셀 파일 다운로드
  - 직원 데이터 일괄 처리
  - 업로드 결과 표시
  - 관리자 권한 검증
  - 반응형 폼 디자인
-->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>엑셀 관리 - 직원 정보</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .excel-card {
      transition: transform 0.2s, box-shadow 0.2s;
      border: none;
      border-radius: 15px;
    }
    .excel-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .upload-area {
      border: 2px dashed #dee2e6;
      border-radius: 15px;
      transition: all 0.3s;
      background: #f8f9fa;
    }
    .upload-area:hover {
      border-color: #0d6efd;
      background: #f0f8ff;
    }
    .upload-area.dragover {
      border-color: #0d6efd;
      background: #e3f2fd;
    }
    .file-preview {
      max-height: 200px;
      overflow-y: auto;
    }
    .progress-bar {
      transition: width 0.3s ease;
    }
    .template-download {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .data-export {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }
    .data-import {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }
    .btn-excel {
      border-radius: 10px;
      font-weight: 600;
      padding: 12px 24px;
      transition: all 0.3s;
    }
    .btn-excel:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body class="bg-light">
  <%- include('header') %>
  
  <div class="container mt-4">
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <h1 class="h2 mb-0">
            <i class="fa-solid fa-file-excel me-2 text-success"></i>
            엑셀 관리
          </h1>
          <a href="/employees" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left me-1"></i>목록으로
          </a>
        </div>
        <p class="text-muted mt-2">직원 정보를 엑셀로 다운로드하거나 업로드할 수 있습니다.</p>
      </div>
    </div>

    <!-- 알림 메시지 -->
    <% if (typeof message !== 'undefined' && message) { %>
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="fa-solid fa-info-circle me-2"></i>
        <%= message %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>

    <!-- 에러 메시지 -->
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fa-solid fa-exclamation-triangle me-2"></i>
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>

    <div class="row g-4">
      <!-- 템플릿 다운로드 -->
      <div class="col-lg-4">
        <div class="card excel-card template-download h-100">
          <div class="card-body text-center p-4">
            <div class="mb-3">
              <i class="fa-solid fa-download fa-3x mb-3"></i>
              <h5 class="card-title">엑셀 템플릿</h5>
              <p class="card-text">직원 정보 입력을 위한 엑셀 템플릿을 다운로드하세요.</p>
            </div>
            <div class="d-grid gap-2">
              <a href="/employees/excel/template" class="btn btn-light btn-excel">
                <i class="fa-solid fa-file-arrow-down me-2"></i>
                템플릿 다운로드
              </a>
              <small class="text-light opacity-75">
                <i class="fa-solid fa-info-circle me-1"></i>
                모든 필수 필드가 포함된 양식
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- 데이터 내보내기 -->
      <div class="col-lg-4">
        <div class="card excel-card data-export h-100">
          <div class="card-body text-center p-4">
            <div class="mb-3">
              <i class="fa-solid fa-file-export fa-3x mb-3"></i>
              <h5 class="card-title">데이터 내보내기</h5>
              <p class="card-text">현재 직원 목록을 엑셀 파일로 다운로드하세요.</p>
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-light btn-excel" onclick="downloadExcel()">
                <i class="fa-solid fa-download me-2"></i>
                엑셀 다운로드
              </button>
              <small class="text-light opacity-75">
                <i class="fa-solid fa-filter me-1"></i>
                검색 조건 적용 가능
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- 데이터 가져오기 -->
      <div class="col-lg-4">
        <div class="card excel-card data-import h-100">
          <div class="card-body text-center p-4">
            <div class="mb-3">
              <i class="fa-solid fa-file-import fa-3x mb-3"></i>
              <h5 class="card-title">데이터 가져오기</h5>
              <p class="card-text">엑셀 파일을 업로드하여 직원 정보를 일괄 등록하세요.</p>
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-light btn-excel" onclick="openUploadModal()">
                <i class="fa-solid fa-upload me-2"></i>
                파일 업로드
              </button>
              <small class="text-light opacity-75">
                <i class="fa-solid fa-exclamation-triangle me-1"></i>
                관리자만 가능
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 사용 가이드 -->
    <div class="row mt-5">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              <i class="fa-solid fa-question-circle me-2"></i>
              사용 가이드
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <h6 class="text-primary">
                  <i class="fa-solid fa-1 me-2"></i>
                  템플릿 다운로드
                </h6>
                <p class="small text-muted">
                  먼저 템플릿을 다운로드하여 올바른 형식으로 데이터를 입력하세요.
                </p>
              </div>
              <div class="col-md-4">
                <h6 class="text-primary">
                  <i class="fa-solid fa-2 me-2"></i>
                  데이터 입력
                </h6>
                <p class="small text-muted">
                  템플릿에 따라 직원 정보를 입력하고 저장하세요.
                </p>
              </div>
              <div class="col-md-4">
                <h6 class="text-primary">
                  <i class="fa-solid fa-3 me-2"></i>
                  파일 업로드
                </h6>
                <p class="small text-muted">
                  완성된 엑셀 파일을 업로드하여 일괄 등록하세요.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 업로드 모달 -->
  <div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-upload me-2"></i>
            엑셀 파일 업로드
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="uploadForm" action="/employees/upload" method="POST" enctype="multipart/form-data">
            <div class="upload-area p-5 text-center" id="uploadArea">
              <i class="fa-solid fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
              <h5>파일을 드래그하거나 클릭하여 선택하세요</h5>
              <p class="text-muted">지원 형식: .xlsx, .csv (최대 10MB)</p>
              <input type="file" id="excelFile" name="excelFile" accept=".xlsx,.csv" class="d-none" required>
              <button type="button" class="btn btn-primary" onclick="document.getElementById('excelFile').click()">
                <i class="fa-solid fa-folder-open me-2"></i>
                파일 선택
              </button>
            </div>
            
            <!-- 파일 미리보기 -->
            <div id="filePreview" class="mt-3" style="display: none;">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">
                    <i class="fa-solid fa-file-excel me-2 text-success"></i>
                    선택된 파일
                  </h6>
                </div>
                <div class="card-body">
                  <div id="fileInfo"></div>
                  <div id="previewContent" class="file-preview mt-3"></div>
                </div>
              </div>
            </div>

            <!-- 업로드 옵션 -->
            <div class="mt-4">
              <h6>업로드 옵션</h6>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="skipHeader" name="skipHeader" checked>
                <label class="form-check-label" for="skipHeader">
                  첫 번째 행을 헤더로 건너뛰기
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="updateExisting" name="updateExisting">
                <label class="form-check-label" for="updateExisting">
                  기존 데이터 업데이트 (이메일 기준)
                </label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" form="uploadForm" class="btn btn-primary" id="uploadBtn" disabled>
            <i class="fa-solid fa-upload me-2"></i>
            업로드 시작
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 진행률 모달 -->
  <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-spinner fa-spin me-2"></i>
            업로드 진행 중...
          </h5>
        </div>
        <div class="modal-body">
          <div class="progress mb-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%" id="uploadProgress"></div>
          </div>
          <p class="text-muted mb-0" id="progressText">파일을 처리하고 있습니다...</p>
        </div>
      </div>
    </div>
  </div>

  <%- include('footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 엑셀 다운로드
    function downloadExcel() {
      const query = window.location.search;
      window.location.href = '/employees/excel' + query;
    }

    // 업로드 모달 열기
    function openUploadModal() {
      const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
      modal.show();
    }

    // 파일 선택 처리
    document.getElementById('excelFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        showFilePreview(file);
        document.getElementById('uploadBtn').disabled = false;
      }
    });

    // 파일 미리보기
    function showFilePreview(file) {
      const fileInfo = document.getElementById('fileInfo');
      const previewContent = document.getElementById('previewContent');
      
      // 파일 정보 표시
      fileInfo.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="fa-solid fa-file-excel text-success me-2"></i>
          <div>
            <strong>${file.name}</strong><br>
            <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
          </div>
        </div>
      `;

      // CSV 파일 미리보기
      if (file.name.endsWith('.csv')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const text = e.target.result;
          const lines = text.split('\n').slice(0, 6); // 처음 5행만 표시
          previewContent.innerHTML = `
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <tbody>
                  ${lines.map(line => `
                    <tr>
                      ${line.split(',').map(cell => `<td class="small">${cell.trim()}</td>`).join('')}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            <small class="text-muted">처음 5행 미리보기</small>
          `;
        };
        reader.readAsText(file);
      } else {
        previewContent.innerHTML = `
          <div class="alert alert-info">
            <i class="fa-solid fa-info-circle me-2"></i>
            엑셀 파일 미리보기는 지원되지 않습니다.
          </div>
        `;
      }

      document.getElementById('filePreview').style.display = 'block';
    }

    // 드래그 앤 드롭
    const uploadArea = document.getElementById('uploadArea');
    
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.name.endsWith('.xlsx') || file.name.endsWith('.csv')) {
          document.getElementById('excelFile').files = files;
          showFilePreview(file);
          document.getElementById('uploadBtn').disabled = false;
        } else {
          alert('지원되지 않는 파일 형식입니다. (.xlsx, .csv 파일만 가능)');
        }
      }
    });

    // 업로드 폼 제출
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
      progressModal.show();
      
      // 진행률 시뮬레이션
      let progress = 0;
      const progressBar = document.getElementById('uploadProgress');
      const progressText = document.getElementById('progressText');
      
      const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) progress = 90;
        
        progressBar.style.width = progress + '%';
        
        if (progress < 30) {
          progressText.textContent = '파일을 분석하고 있습니다...';
        } else if (progress < 60) {
          progressText.textContent = '데이터를 검증하고 있습니다...';
        } else if (progress < 90) {
          progressText.textContent = '데이터베이스에 저장하고 있습니다...';
        } else {
          progressText.textContent = '완료 중...';
        }
      }, 200);

      // 실제 폼 제출
      const formData = new FormData(this);
      fetch('/employees/upload', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        clearInterval(interval);
        progressBar.style.width = '100%';
        progressText.textContent = '업로드 완료!';
        
        setTimeout(() => {
          progressModal.hide();
          if (data.success) {
            window.location.href = '/employees?message=' + encodeURIComponent(data.message);
          } else {
            alert('업로드 중 오류가 발생했습니다: ' + data.error);
          }
        }, 1000);
      })
      .catch(error => {
        clearInterval(interval);
        progressModal.hide();
        alert('업로드 중 오류가 발생했습니다: ' + error.message);
      });
    });
  </script>
</body>
</html> 