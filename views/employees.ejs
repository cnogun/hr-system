<!--
  파일명: employees.ejs
  목적: 직원 목록 페이지
  기능:
  - 직원 목록 표시 및 페이징
  - 직원 검색 및 필터링
  - 직원 정보 추가/수정/삭제
  - 엑셀 파일 업로드/다운로드
  - 권한별 기능 표시/숨김
  - 반응형 테이블 디자인
  - 고급 검색 및 필터링
-->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>직원 목록</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e2eafc 100%);
      min-height: 100vh;
    }
    .employee-card {
      transition: all 0.3s ease-in-out;
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .employee-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    }
    .table-responsive {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .table thead th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      font-weight: 600;
      font-size: 0.9rem;
      padding: 1rem 0.75rem;
    }
    .table tbody tr {
      transition: background-color 0.2s ease;
    }
    .table tbody tr:hover {
      background-color: #f8f9fa;
      transform: scale(1.01);
    }
    .search-form {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 2rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(0,0,0,0.05);
    }
    .search-form .form-control,
    .search-form .form-select {
      border-radius: 8px;
      border: 1px solid #e1e5e9;
      transition: all 0.2s ease;
    }
    .search-form .form-control:focus,
    .search-form .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .btn {
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .btn-xs {
      padding: 0.375rem 0.75rem;
      font-size: 0.8rem;
      border-radius: 6px;
    }
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .stats-number {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    /* 모바일 최적화 스타일 */
    @media (max-width: 768px) {
      .container {
        padding: 0.5rem;
      }
      
      .search-form {
        padding: 1.5rem 1rem;
        margin-bottom: 1.5rem;
        border-radius: 12px;
      }
      
      .search-form .row {
        margin: 0;
      }
      
      .search-form .col-md-3,
      .search-form .col-md-2 {
        margin-bottom: 1rem;
        padding: 0 0.5rem;
      }
      
      .search-form .form-control,
      .search-form .form-select {
        font-size: 0.9rem;
        padding: 0.75rem 0.5rem;
      }
      
      .btn {
        width: 100%;
        margin-bottom: 0.5rem;
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }
      
      .btn-group {
        width: 100%;
        flex-direction: column;
      }
      
      .btn-group .btn {
        margin-bottom: 0.5rem;
        border-radius: 8px !important;
      }
      
      .stats-card {
        padding: 1.25rem 1rem;
        margin-bottom: 1rem;
        text-align: center;
      }
      
      .stats-number {
        font-size: 1.75rem;
      }
      
      .table-responsive {
        border-radius: 8px;
        margin-bottom: 1rem;
      }
      
      .table thead th {
        padding: 0.75rem 0.5rem;
        font-size: 0.8rem;
      }
      
      .table tbody td {
        padding: 0.75rem 0.5rem;
        font-size: 0.85rem;
      }
      
      .table .btn-xs {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        margin: 0.25rem 0.25rem 0.25rem 0;
      }
      
      .pagination {
        justify-content: center;
        flex-wrap: wrap;
        gap: 0.25rem;
      }
      
      .pagination .page-link {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
      }
      
      .d-flex.justify-content-between {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
      }
      
      .d-flex.justify-content-between .btn {
        width: 100%;
      }
    }
    
    /* 작은 모바일 화면 최적화 */
    @media (max-width: 576px) {
      .container {
        padding: 0.25rem;
      }
      
      .search-form {
        padding: 1rem 0.75rem;
        margin-bottom: 1rem;
      }
      
      .search-form .col-md-3,
      .search-form .col-md-2 {
        padding: 0 0.25rem;
        margin-bottom: 0.75rem;
      }
      
      .search-form .form-control,
      .search-form .form-select {
        font-size: 0.85rem;
        padding: 0.5rem 0.5rem;
      }
      
      .btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
      }
      
      .stats-card {
        padding: 1rem 0.75rem;
        margin-bottom: 0.75rem;
      }
      
      .stats-number {
        font-size: 1.5rem;
      }
      
      .table thead th {
        padding: 0.5rem 0.25rem;
        font-size: 0.75rem;
      }
      
      .table tbody td {
        padding: 0.5rem 0.25rem;
        font-size: 0.8rem;
      }
      
      .table .btn-xs {
        padding: 0.375rem 0.5rem;
        font-size: 0.7rem;
        margin: 0.125rem;
      }
      
      .pagination .page-link {
        padding: 0.375rem 0.5rem;
        font-size: 0.8rem;
      }
    }
    
    /* 태블릿 최적화 */
    @media (min-width: 769px) and (max-width: 1024px) {
      .search-form {
        padding: 1.75rem 1.5rem;
      }
      
      .search-form .col-md-3,
      .search-form .col-md-2 {
        margin-bottom: 1rem;
      }
      
      .stats-card {
        padding: 1.75rem 1.5rem;
      }
      
      .table thead th {
        padding: 0.875rem 0.625rem;
      }
      
      .table tbody td {
        padding: 0.875rem 0.625rem;
      }
    }
    
    /* 터치 디바이스 최적화 */
    @media (hover: none) and (pointer: coarse) {
      .employee-card:hover,
      .table tbody tr:hover {
        transform: none;
      }
      
      .btn:hover {
        transform: none;
      }
      
      .employee-card:active,
      .table tbody tr:active {
        background-color: #f8f9fa;
        transform: scale(0.98);
      }
      
      .btn:active {
        transform: scale(0.95);
      }
      
      .table .btn-xs {
        min-height: 44px;
        min-width: 44px;
      }
      
      .pagination .page-link {
        min-height: 44px;
        min-width: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
    
    /* 모바일에서 테이블 스크롤 최적화 */
    @media (max-width: 768px) {
      .table-responsive {
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: #667eea #f1f1f1;
      }
      
      .table-responsive::-webkit-scrollbar {
        height: 6px;
      }
      
      .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }
      
      .table-responsive::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 3px;
      }
      
      .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #5a6fd8;
      }
    }
  </style>
</head>
<body>
  <%- include('header') %>
  
  <div class="container mt-4 flex-grow-1">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-11">
        <!-- 통계 카드 섹션 제거됨 -->

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
          <h2 class="mb-3 mb-md-0">
            <i class="fa-solid fa-users text-primary me-2"></i>직원 찾기
          </h2>
        </div>
        
        <% if (typeof message !== 'undefined' && message) { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fa-solid fa-check-circle me-2"></i>
            <%= message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% } %>

        <!-- 고급 검색 폼 -->
        <div class="search-form">
          <form method="get" action="/employees" class="row g-3">
            <div class="col-md-3">
              <label class="form-label fw-bold">이름/사번</label>
              <input type="text" name="search" class="form-control" placeholder="이름 또는 사번으로 검색" value="<%= query.search || '' %>">
            </div>
            <div class="col-md-2">
              <label class="form-label fw-bold">부서</label>
              <select name="department" class="form-select">
                <option value="">전체 부서</option>
                <% departments.forEach(function(dept) { %>
                  <option value="<%= dept %>" <%= query.department === dept ? 'selected' : '' %>><%= dept %></option>
                <% }); %>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label fw-bold">직급</label>
              <select name="position" class="form-select">
                <option value="">전체 직급</option>
                <option value="사원" <%= query.position === '사원' ? 'selected' : '' %>>사원</option>
                <option value="주임" <%= query.position === '주임' ? 'selected' : '' %>>주임</option>
                <option value="대리" <%= query.position === '대리' ? 'selected' : '' %>>대리</option>
                <option value="과장" <%= query.position === '과장' ? 'selected' : '' %>>과장</option>
                <option value="차장" <%= query.position === '차장' ? 'selected' : '' %>>차장</option>
                <option value="부장" <%= query.position === '부장' ? 'selected' : '' %>>부장</option>
              </select>
            </div>
            <div class="col-md-5 d-flex align-items-end justify-content-end">
              <button type="submit" class="btn btn-primary me-2 px-3">
                <i class="fa-solid fa-search me-1"></i>검색
              </button>
              <a href="/employees" class="btn btn-outline-secondary px-3">
                <i class="fa-solid fa-undo me-1"></i>초기화
              </a>
            </div>
          </form>
          
          <!-- 검색 결과 요약 -->
          <% if (query.search || query.department || query.position) { %>
            <div class="mt-3 p-3 bg-light rounded">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>검색 조건:</strong>
                  <% if (query.search) { %>
                    <span class="badge bg-primary me-2">이름/사번: <%= query.search %></span>
                  <% } %>
                  <% if (query.department) { %>
                    <span class="badge bg-info me-2">부서: <%= query.department %></span>
                  <% } %>
                  <% if (query.position) { %>
                    <span class="badge bg-success me-2">직급: <%= query.position %></span>
                  <% } %>
                </div>
                <div>
                  <strong>검색 결과:</strong> <span class="text-primary"><%= employees.length %>명</span>
                </div>
              </div>
            </div>
          <% } %>
        </div>

        <div class="card employee-card">
          <div class="card-body p-0">
            <form id="bulkDeleteForm" method="POST">
              <input type="hidden" name="_method" value="DELETE">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 small text-center">
                  <thead>
                    <tr>
                      <% if (session && session.userRole === 'admin') { %>
                      <th style="width: 40px;" class="text-center"><input type="checkbox" id="selectAll"></th>
                      <% } %>
                      <th style="width: 80px;" class="text-center">프로필</th>
                      <th style="width: 120px;" class="text-center">이름</th>
                      <th style="width: 100px;" class="text-center">사번</th>
                      <th style="width: 110px;" class="text-center">부서</th>
                      <th style="width: 90px;" class="text-center">직급</th>
                      <th style="width: 200px;" class="text-center">이메일</th>
                      <th style="width: 130px;" class="text-center">휴대폰</th>
                      <th style="width: 110px;" class="text-center">입사일</th>
                      <th style="width: 140px;" class="text-center">관리</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (query && (query.search || query.department || query.position)) { %>
                      <% if (employees && employees.length > 0) { %>
                        <% employees.forEach(function(employee) { %>
                          <tr>
                            <% if (session && session.userRole === 'admin') { %>
                            <td class="text-center"><input type="checkbox" name="ids" value="<%= employee._id %>"></td>
                            <% } %>
                            <td class="text-center">
                              <% if (employee.profileImage) { %>
                                <img src="<%= employee.profileImage %>" alt="프로필 사진" class="rounded-circle border border-2" style="width: 48px; height: 48px; object-fit: cover;">
                              <% } else { %>
                                <span class="fa-stack text-secondary" style="font-size: 1.2em;">
                                  <i class="fa-solid fa-circle fa-stack-2x"></i>
                                  <i class="fa-solid fa-user fa-stack-1x fa-inverse"></i>
                                </span>
                              <% } %>
                            </td>
                            <td class="text-center"><a href="/admin/employees/<%= employee._id %>" class="text-decoration-none fw-bold text-dark" style="font-size: 1.1rem;"><%= employee.name %></a></td>
                            <td class="text-center small"><%= employee.empNo || '-' %></td>
                            <td class="text-center small"><%= employee.department %></td>
                            <td class="text-center small"><%= employee.position %></td>
                            <td class="text-center small"><%= employee.email %></td>
                            <td class="text-center small"><%= employee.mobile || '-' %></td>
                            <td class="text-center small"><%= employee.hireDate.toISOString().slice(0,10) %></td>
                            <td class="text-center">
                              <% if (session && session.userRole === 'admin') { %>
                                <a href="/uniform/<%= employee._id %>/edit" class="btn btn-xs btn-outline-success">유니폼</a>
                              <% } else if (employee.userId && employee.userId.toString() === (session && session.userId)) { %>
                                <a href="/uniform" class="btn btn-xs btn-outline-success">유니폼</a>
                              <% } %>
                            </td>
                          </tr>
                        <% }) %>
                      <% } else { %>
                        <tr>
                          <td colspan="<%= session && session.userRole === 'admin' ? 10 : 9 %>" class="text-center py-4">
                            <div class="text-muted">
                              <i class="fas fa-search fa-2x mb-2"></i>
                              <h5>검색 결과가 없습니다</h5>
                              <% if (query.search) { %>
                                <p>검색어: "<%= query.search %>"</p>
                              <% } %>
                              <p class="small">다른 검색어를 입력하거나 검색 조건을 변경해보세요.</p>
                            </div>
                          </td>
                        </tr>
                      <% } %>
                    <% } else { %>
                      <tr>
                        <td colspan="<%= session && session.userRole === 'admin' ? 10 : 9 %>" class="text-center py-4">
                          <div class="text-muted">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <h4 class="mb-3">직원 검색</h4>
                            <p>위의 검색 조건을 입력하고 검색 버튼을 클릭하여 직원을 찾아보세요.</p>
                          </div>
                        </td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </form>
          </div>
        </div>
        
        <% if (query && (query.search || query.department || query.position) && employees && employees.length > 0) { %>
        <div class="d-flex justify-content-center align-items-center mt-3">
          <nav aria-label="페이지네이션">
            <ul class="pagination pagination-sm mb-0">
              <% if (page > 1) { %>
                <li class="page-item">
                  <a class="page-link" href="/employees?page=<%= page - 1 %><%= query.search ? '&search=' + query.search : '' %><%= query.department ? '&department=' + query.department : '' %><%= query.position ? '&position=' + query.position : '' %><%= query.sort ? '&sort=' + query.sort : '' %><%= query.order ? '&order=' + query.order : '' %>">이전</a>
                </li>
              <% } %>
              
              <% for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) { %>
                <li class="page-item <%= i === page ? 'active' : '' %>">
                  <a class="page-link" href="/employees?page=<%= i %><%= query.search ? '&search=' + query.search : '' %><%= query.department ? '&department=' + query.department : '' %><%= query.position ? '&position=' + query.position : '' %><%= query.sort ? '&sort=' + query.sort : '' %><%= query.order ? '&order=' + query.order : '' %>"><%= i %></a>
                </li>
              <% } %>
              
              <% if (page < totalPages) { %>
                <li class="page-item">
                  <a class="page-link" href="/employees?page=<%= page + 1 %><%= query.search ? '&search=' + query.search : '' %><%= query.department ? '&department=' + query.department : '' %><%= query.position ? '&position=' + query.position : '' %><%= query.sort ? '&sort=' + query.sort : '' %><%= query.order ? '&order=' + query.order : '' %>">다음</a>
                </li>
              <% } %>
            </ul>
          </nav>
        </div>
        <% } %>
      </div>
    </div>
  </div>
  
  <%- include('footer') %>
  
  <script>
    // 전체 선택 체크박스
    document.getElementById('selectAll').addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('input[name="ids"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
    });
  </script>
</body>
</html> 