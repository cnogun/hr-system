<%- include('header') %>

<!-- Ïù∏ÏáÑ ÏµúÏ†ÅÌôî CSS Î∞è JavaScript -->
<link rel="stylesheet" href="/print-optimization.css">
<script src="/print-optimization.js"></script>

<!-- ÌîåÎûòÏãú Î©îÏãúÏßÄ ÌëúÏãú -->
<% if (typeof message !== 'undefined' && message) { %>
<div class="alert alert-success alert-dismissible fade show" role="alert" style="margin-bottom: 20px;">
    <strong>‚úÖ ÏÑ±Í≥µ!</strong> <%= message %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<% } %>

<% if (typeof error !== 'undefined' && error) { %>
<div class="alert alert-danger alert-dismissible fade show" role="alert" style="margin-bottom: 20px;">
    <strong>‚ùå Ïò§Î•ò!</strong> <%= error %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<% } %>

<style>
        
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }
        
        .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .date-info {
            font-size: 16px;
            color: #666;
        }
        
        .handover-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .handover-table th,
        .handover-table td {
            border: 1px solid #333;
            padding: 8px 12px;
            text-align: left;
            vertical-align: top;
        }
        
        .handover-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }
        
        .task-type {
            font-weight: bold;
            margin-bottom: 5px;
            color: #1976d2;
        }
        
        .task-details {
            margin-bottom: 8px;
        }
        
        .task-details div {
            margin-bottom: 3px;
            font-size: 13px;
        }
        
        .datetime {
            color: #007bff;
            font-weight: bold;
        }
        
        .personnel {
            color: #28a745;
        }
        
        .location {
            color: #6c757d;
        }
        
        .content {
            color: #333;
        }
        
        .additional-info {
            color: #dc3545;
            font-style: italic;
        }
        
        .report-completed {
            text-align: center;
            font-weight: bold;
            color: #28a745;
        }
        
        .team-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            min-width: 30px;
        }
        
        .team-1 {
            background-color: #007bff;
            color: white;
        }
        
        .team-2 {
            background-color: #28a745;
            color: white;
        }
        
        .team-3 {
            background-color: #dc3545;
            color: white;
        }
        
        .time-category {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .time-day {
            background-color: #ffc107;
            color: #212529;
        }
        
        .time-night {
            background-color: #6c757d;
            color: white;
        }
        
        .time-late {
            background-color: #343a40;
            color: white;
        }
        
        .summary-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .summary-title {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .handover-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .security-badge {
            display: inline-block;
            background-color: #1976d2;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        @media (max-width: 768px) {
            .summary-section {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .handover-table {
                font-size: 12px;
            }
            
            .handover-table th,
            .handover-table td {
                padding: 4px 6px;
            }
            
            .summary-section {
                grid-template-columns: 1fr;
            }
        }
    </style>

<div class="container mt-4">
        <!-- Ìó§Îçî -->
        <div class="header">
            <div class="title">Î≥¥ÏïàÏóÖÎ¨¥ Ïù∏Í≥ÑÏû•<span class="security-badge">Î≥¥ÏïàÏóÖÎ¨¥</span></div>
            <div class="date-info"><%= handover.formattedHandoverDate %></div>
            <% if (handover.handoverFrom) { %>
            <div class="handover-info" style="margin-top: 10px; font-size: 14px; color: #666;">
                <strong>Ïù∏Í≥ÑÏûê:</strong> <%= handover.handoverFrom.name %> (<%= handover.handoverFrom.empNo %>)
            </div>
            <% } %>
        </div>

        <!-- ÏöîÏïΩ Ï†ïÎ≥¥ -->
        <div class="summary-section">
            <div class="summary-card">
                <div class="summary-title">Ï†ÑÏ≤¥ Î≥¥ÏïàÏóÖÎ¨¥</div>
                <div class="summary-value"><%= handover.totalItemsCount %></div>
            </div>
            <div class="summary-card">
                <div class="summary-title">ÏôÑÎ£åÎêú Î≥¥Í≥†</div>
                <div class="summary-value"><%= handover.completedReportsCount %></div>
            </div>
            <div class="summary-card">
                <div class="summary-title">1Î∞ò</div>
                <div class="summary-value"><%= handover.teamItemsCount['1Î∞ò'] || 0 %></div>
            </div>
            <div class="summary-card">
                <div class="summary-title">2Î∞ò</div>
                <div class="summary-value"><%= handover.teamItemsCount['2Î∞ò'] || 0 %></div>
            </div>
            <div class="summary-card">
                <div class="summary-title">3Î∞ò</div>
                <div class="summary-value"><%= handover.teamItemsCount['3Î∞ò'] || 0 %></div>
            </div>
        </div>

        <!-- Î≥¥ÏïàÏóÖÎ¨¥ Ïù∏Í≥ÑÏû• ÌÖåÏù¥Î∏î -->
        <table class="handover-table">
            <thead>
                <tr>
                    <th style="width: 60%;">Î≥¥ÏïàÏóÖÎ¨¥ ÎÇ¥Ïö©</th>
                    <th style="width: 15%;">Î≥¥Í≥†ÏôÑÎ£å</th>
                    <th style="width: 10%;">Îã¥ÎãπÌåÄ</th>
                    <th style="width: 15%;">ÏãúÍ∞ÑÎåÄ</th>
                </tr>
            </thead>
            <tbody>
                <% if (handover.handoverItems && handover.handoverItems.length > 0) { %>
                    <% handover.handoverItems.forEach(function(item, index) { %>
                    <tr>
                        <td>
                            <div class="task-type">üîí <%= item.taskType %></div>
                            <% if (item.taskDetails) { %>
                                <% if (item.taskDetails.dateTime) { %>
                                <div class="task-details">
                                    <div class="datetime">
                                        Í∑ºÎ¨¥ÏãúÍ∞Ñ: <%= item.taskDetails.dateTime.date %> <%= item.taskDetails.dateTime.startTime %>~<%= item.taskDetails.dateTime.endTime %>
                                    </div>
                                    <% if (item.taskDetails.personnel) { %>
                                    <div class="personnel">
                                        Îã¥ÎãπÏöîÏõê: <%= item.taskDetails.personnel.name %>
                                        <% if (item.taskDetails.personnel.phone) { %>
                                        (<%= item.taskDetails.personnel.phone %>)
                                        <% } %>
                                    </div>
                                    <% } %>
                                    <% if (item.taskDetails.location) { %>
                                    <div class="location">
                                        Í∑ºÎ¨¥Íµ¨Ïó≠: <%= item.taskDetails.location %>
                                    </div>
                                    <% } %>
                                    <% if (item.taskDetails.content) { %>
                                    <div class="content">
                                        ÏóÖÎ¨¥ÎÇ¥Ïö©: <%= item.taskDetails.content %>
                                    </div>
                                    <% } %>
                                    <% if (item.taskDetails.additionalInfo) { %>
                                    <div class="additional-info">
                                        ‚ö†Ô∏è ÌäπÏù¥ÏÇ¨Ìï≠: <%= item.taskDetails.additionalInfo %>
                                    </div>
                                    <% } %>
                                </div>
                                <% } %>
                            <% } %>
                        </td>
                        <td class="report-completed">
                            <%= item.reportCompleted ? '‚úÖ ÏôÑÎ£å' : '‚è≥ ÎØ∏ÏôÑÎ£å' %>
                        </td>
                        <td style="text-align: center;">
                            <span class="team-badge team-<%= item.assignedTeam.charAt(0) %>">
                                <%= item.assignedTeam %>
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <span class="time-category time-<%= item.timeCategory === 'Ï£ºÍ∞Ñ' ? 'day' : (item.timeCategory === 'ÏïºÍ∞Ñ' ? 'night' : 'late') %>">
                                <%= item.timeCategory %>
                            </span>
                        </td>
                    </tr>
                    <% }); %>
                <% } else { %>
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                            Îì±Î°ùÎêú Î≥¥ÏïàÏóÖÎ¨¥ Ïù∏Í≥ÑÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.
                        </td>
                    </tr>
                <% } %>
            </tbody>
        </table>

        <!-- Î≤ÑÌäº Í∑∏Î£π -->
        <div class="btn-group">
            <a href="/handovers" class="btn btn-secondary">Î™©Î°ùÏúºÎ°ú</a>
            <% if (userRole === 'admin') { %>
            <a href="/handovers/<%= handover._id %>/edit" class="btn btn-primary">ÏàòÏ†ï</a>
            <button onclick="deleteHandover('<%= handover._id %>')" class="btn btn-danger">ÏÇ≠Ï†ú</button>
            <% } %>
            <a href="/handovers/<%= handover._id %>/print" class="btn btn-success print-btn" target="_blank">Ïù∏ÏáÑ</a>
            <a href="/handovers/<%= handover._id %>/print?preview=true" class="btn btn-info print-preview-btn" target="_blank">Ïù∏ÏáÑ ÎØ∏Î¶¨Î≥¥Í∏∞</a>
        </div>
    </div>

<%- include('footer') %>

<script>
    // Ïù∏Í≥ÑÏû• ÏÇ≠Ï†ú Í∏∞Îä•
    function deleteHandover(handoverId) {
        if (confirm('Ï†ïÎßêÎ°ú Ïù¥ Î≥¥ÏïàÏóÖÎ¨¥ Ïù∏Í≥ÑÏû•ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏÇ≠Ï†úÎêú Îç∞Ïù¥ÌÑ∞Îäî Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.')) {
            fetch(`/handovers/${handoverId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Î≥¥ÏïàÏóÖÎ¨¥ Ïù∏Í≥ÑÏû•Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    window.location.href = '/handovers';
                } else {
                    alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            });
        }
    }
    
    // Ïù∏ÏáÑ Í∏∞Îä•
    function printHandover() {
        window.print();
    }
</script>
</body>
</html>
