<!--
  파일명: header.ejs
  목적: 애플리케이션 공통 헤더 컴포넌트
  기능:
  - 네비게이션 메뉴 표시
  - 사용자 로그인 상태 표시
  - 권한별 메뉴 표시/숨김
  - 로그아웃 기능
  - 반응형 디자인 적용
  - 현대적인 UI/UX
-->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<header class="sticky-top shadow-lg bg-white border-bottom">
  <div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center">
      <!-- 로고 및 브랜드 -->
      <div class="d-flex align-items-center gap-3">
        <div class="brand-logo">
          <i class="fa-solid fa-users-gear fa-2x text-primary"></i>
        </div>
        <div class="brand-text">
          <h2 class="mb-0 fw-bold text-primary">인사관리 시스템</h2>
          <small class="text-muted">Human Resource Management System</small>
        </div>
      </div>
      
      <% if (typeof session !== 'undefined' && session && session.userId) { %>
      <!-- 네비게이션 메뉴 -->
      <nav class="navbar navbar-expand-lg">
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link d-flex align-items-center" href="/dashboard">
                <i class="fa-solid fa-chart-line me-2"></i> 대시보드
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link d-flex align-items-center" href="/employees">
                <i class="fa-solid fa-users me-2"></i>직원 찾기
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link d-flex align-items-center" href="/boards">
                <i class="fa-solid fa-comments me-2"></i> 게시판
              </a>
            </li>
            

            
            <% if ((typeof session !== 'undefined' && session && session.userRole === 'admin') || (typeof userRole !== 'undefined' && userRole === 'admin')) { %>
            <!-- 관리자 메뉴 -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                <i class="fa-solid fa-cog me-2"></i> 관리자
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">시스템 관리</h6></li>
                <li><a class="dropdown-item" href="/boards/admin/reports">
                  <i class="fa-solid fa-flag me-2"></i> 게시판 신고 관리
                </a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><h6 class="dropdown-header">데이터 관리</h6></li>
                  <li><a class="dropdown-item" href="/uniform/stats">
                    <i class="fa-solid fa-tshirt me-2"></i> 유니폼 현황
                  </a></li>
                  <li><a class="dropdown-item" href="/auth/logs">
                    <i class="fa-solid fa-history me-2"></i> 활동 로그 관리
                  </a></li>
                </ul>
              </li>
             
             <!-- 엑셀관리 메뉴 -->
             <li class="nav-item dropdown">
               <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="excelDropdown" role="button" data-bs-toggle="dropdown">
                 <i class="fa-solid fa-file-excel me-2"></i> 엑셀관리
               </a>
               <ul class="dropdown-menu dropdown-menu-end">
                 <li><h6 class="dropdown-header">통합 엑셀 관리</h6></li>
                 <li><a class="dropdown-item" href="/excelManager">
                   <i class="fa-solid fa-table me-2"></i> 통합 엑셀 관리
                 </a></li>
              </ul>
            </li>
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="employeeInputDropdown" role="button" data-bs-toggle="dropdown">
                <i class="fa-solid fa-user-plus me-2"></i> 정보 입력
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">직원 등록</h6></li>
                <li><a class="dropdown-item" href="/employees/new">
                  <i class="fa-solid fa-user-plus me-2"></i>신입사원등록
                </a></li>
                <li><a class="dropdown-item" href="/employees/existing">
                  <i class="fa-solid fa-user-edit me-2"></i>등록사원수정
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">근태 관리</h6></li>
                <li><a class="dropdown-item" href="/attendance">
                  <i class="fa-solid fa-clock me-2"></i>근태 입력
                </a></li>
                <li><a class="dropdown-item" href="/monthlyAttendance">
                  <i class="fa-solid fa-calendar-days me-2"></i>월간 근태현황
                </a></li>
                <li><a class="dropdown-item" href="/workSchedule">
                  <i class="fa-solid fa-calendar-alt me-2"></i>근무 스케줄 관리
                </a></li>
              </ul>
            </li>
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="securityWorkDropdown" role="button" data-bs-toggle="dropdown">
                <i class="fa-solid fa-shield-alt me-2"></i> 보안업무
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">보안 관리</h6></li>
                <li><a class="dropdown-item" href="/security/duty-orders">
                  <i class="fa-solid fa-clipboard-list me-2"></i> 근무명령서
                </a></li>
                <li><a class="dropdown-item" href="/security/handover">
                  <i class="fa-solid fa-exchange-alt me-2"></i> 인계사항
                </a></li>
                <li><a class="dropdown-item" href="/security/schedule">
                  <i class="fa-solid fa-calendar-alt me-2"></i> 일정
                </a></li>
              </ul>
            </li>
            <% } %>
          </ul>
        </div>
      </nav>
      <% } %>
      
      <!-- 사용자 정보 및 액션 -->
      <div class="d-flex align-items-center gap-3">
        <% if (typeof session !== 'undefined' && session && session.userId) { %>
          <a href="/notice/new" class="btn btn-warning btn-sm me-2">
            <i class="fa-solid fa-bullhorn me-1"></i> 시스템 공지
          </a>
          
          <div class="vr mx-2" style="height: 35px; opacity: 0.3;"></div>
          
          <div class="user-info text-end">
            <div class="fw-semibold text-primary" style="font-size: 0.9rem;">
              <i class="fa-solid fa-user me-1"></i>관리자
            </div>
            <div class="fw-semibold text-dark" style="font-size: 0.9rem;">
              <i class="fa-solid fa-user-tie me-1"></i><%= position %>
            </div>
          </div>
          
          <a href="/auth/logout" class="btn btn-outline-danger btn-sm">
            <i class="fa-solid fa-right-from-bracket me-1"></i> 로그아웃
          </a>
        <% } else { %>
          <div class="auth-actions">
            <a href="/auth/login" class="btn btn-primary btn-sm me-2">
              <i class="fa-solid fa-sign-in-alt me-1"></i> 로그인
            </a>
            <a href="/auth/register" class="btn btn-outline-primary btn-sm">
              <i class="fa-solid fa-user-plus me-1"></i> 회원가입
            </a>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</header>

<script>
// 전역 변수로 이벤트 리스너 중복 등록 방지
let dropdownInitialized = false;
let eventListenersAttached = false;

// 디버깅을 위한 콘솔 로그
console.log('Header script 로드됨');
console.log('Bootstrap 상태:', typeof bootstrap);
console.log('Document ready:', document.readyState);

// Bootstrap 드롭다운이 로드될 때까지 대기
function waitForBootstrap() {
  if (typeof bootstrap !== 'undefined') {
    console.log('Bootstrap 로드됨, 드롭다운 초기화 시작');
    
    if (!dropdownInitialized) {
      initializeDropdowns();
      dropdownInitialized = true;
    }
    
    if (!eventListenersAttached) {
      attachEventListeners();
      eventListenersAttached = true;
    }
    
    console.log('모든 드롭다운 초기화 완료');
  } else {
    console.log('Bootstrap 로드 대기 중...');
    setTimeout(waitForBootstrap, 100);
  }
}

// 드롭다운 초기화 함수
function initializeDropdowns() {
  document.querySelectorAll('.dropdown-toggle').forEach(function(element) {
    try {
      // 기존 인스턴스가 있다면 제거
      const existingInstance = bootstrap.Dropdown.getInstance(element);
      if (existingInstance) {
        existingInstance.dispose();
      }
      
      // aria-expanded 속성 명시적 설정
      element.setAttribute('aria-expanded', 'false');
      
      // 새 인스턴스 생성
      const dropdown = new bootstrap.Dropdown(element, {
        autoClose: true,
        boundary: 'viewport'
      });
      
      // 드롭다운 상태 변경 이벤트 리스너 추가
      element.addEventListener('show.bs.dropdown', function() {
        this.setAttribute('aria-expanded', 'true');
        console.log('드롭다운 열림:', this.textContent.trim());
        
        // 다른 모든 드롭다운 닫기
        closeAllOtherDropdowns(this);
        
        // 다른 모든 메뉴의 active 상태 제거
        document.querySelectorAll('.navbar-nav .nav-link.active, .dropdown-item.active').forEach(link => {
          if (link !== this) {
            link.classList.remove('active');
          }
        });
        
        // 현재 드롭다운 토글만 active 상태로 설정
        this.classList.add('active');
      });
      
      element.addEventListener('hide.bs.dropdown', function() {
        this.setAttribute('aria-expanded', 'false');
        console.log('드롭다운 닫힘:', this.textContent.trim());
        
        // 드롭다운이 닫힐 때 active 상태 제거
        this.classList.remove('active');
      });
      
      console.log('드롭다운 초기화됨:', element.textContent.trim());
      
    } catch (error) {
      console.error('드롭다운 초기화 오류:', error);
    }
  });
}

// 이벤트 리스너 등록 함수
function attachEventListeners() {
  // 드롭다운 토글 클릭 이벤트
  document.addEventListener('click', function(e) {
    const dropdownToggle = e.target.closest('.dropdown-toggle');
    if (dropdownToggle) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('드롭다운 토글 클릭됨:', dropdownToggle.textContent.trim());
      
      // 모든 메뉴의 active 상태 초기화 (드롭다운 토글과 하위 메뉴 모두)
      document.querySelectorAll('.navbar-nav .nav-link.active, .dropdown-item.active').forEach(link => {
        link.classList.remove('active');
      });
      
      // 클릭된 드롭다운 토글에만 active 상태 설정
      dropdownToggle.classList.add('active');
      console.log('드롭다운 토글 active 상태 설정됨:', dropdownToggle.textContent.trim());
      
      // 다른 모든 드롭다운 닫기
      closeAllOtherDropdowns(dropdownToggle);
      
      // Bootstrap 드롭다운 토글
      const dropdown = bootstrap.Dropdown.getInstance(dropdownToggle);
      if (dropdown) {
        // 현재 상태 확인
        const isExpanded = dropdownToggle.getAttribute('aria-expanded') === 'true';
        
        if (isExpanded) {
          dropdown.hide();
          dropdownToggle.setAttribute('aria-expanded', 'false');
          // 드롭다운이 닫힐 때 active 상태도 제거
          dropdownToggle.classList.remove('active');
        } else {
          dropdown.show();
          dropdownToggle.setAttribute('aria-expanded', 'true');
        }
      }
    }
    
    // 드롭다운 메뉴 외부 클릭 시 모든 드롭다운 닫기 및 active 상태 초기화
    if (!e.target.closest('.dropdown')) {
      closeAllDropdowns();
      // 외부 클릭 시 모든 active 상태 제거
      document.querySelectorAll('.navbar-nav .nav-link.active, .dropdown-item.active').forEach(link => {
        link.classList.remove('active');
      });
    }
  });
  
  // 메뉴 링크 클릭 이벤트
  document.addEventListener('click', function(e) {
    const menuLink = e.target.closest('.nav-link:not(.dropdown-toggle), .dropdown-item');
    if (menuLink && menuLink.getAttribute('href') && menuLink.getAttribute('href') !== '#') {
      console.log('메뉴 링크 클릭됨:', menuLink.textContent.trim());
      
      // 모든 드롭다운 닫기
      closeAllDropdowns();
      
      // 모든 메뉴의 active 상태 완전 초기화
      document.querySelectorAll('.navbar-nav .nav-link.active, .dropdown-item.active').forEach(link => {
        link.classList.remove('active');
      });
      
      // 클릭된 메뉴에만 active 상태 설정
      menuLink.classList.add('active');
      
      // 드롭다운 메뉴인 경우 상위 메뉴도 active
      if (menuLink.classList.contains('dropdown-item')) {
        const parentDropdown = menuLink.closest('.dropdown');
        if (parentDropdown) {
          const parentToggle = parentDropdown.querySelector('.dropdown-toggle');
          if (parentToggle) {
            parentToggle.classList.add('active');
            console.log('상위 드롭다운 토글 active 상태 설정됨:', parentToggle.textContent.trim());
          }
        }
      }
      
      console.log('메뉴 링크 active 상태 설정됨:', menuLink.textContent.trim());
    }
  });
}

// 모든 드롭다운 닫기 함수
function closeAllDropdowns() {
  document.querySelectorAll('.dropdown-toggle').forEach(function(toggle) {
    const dropdown = bootstrap.Dropdown.getInstance(toggle);
    if (dropdown) {
      dropdown.hide();
      toggle.setAttribute('aria-expanded', 'false');
    }
  });
}

// 다른 모든 드롭다운 닫기 함수
function closeAllOtherDropdowns(currentToggle) {
  document.querySelectorAll('.dropdown-toggle').forEach(function(toggle) {
    if (toggle !== currentToggle) {
      const dropdown = bootstrap.Dropdown.getInstance(toggle);
      if (dropdown) {
        dropdown.hide();
        toggle.setAttribute('aria-expanded', 'false');
      }
    }
  });
}



// 로딩 토스트 표시 함수
function showLoadingToast(message) {
  const toastContainer = document.getElementById('toast-container') || createToastContainer();
  
  const toast = document.createElement('div');
  toast.className = 'toast show bg-info text-white';
  toast.innerHTML = `
    <div class="toast-body d-flex align-items-center">
      <div class="spinner-border spinner-border-sm me-2" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      ${message}
    </div>
  `;
  
  toastContainer.appendChild(toast);
  return toast;
}

// 로딩 토스트 숨기기 함수
function hideLoadingToast(toast) {
  if (toast && toast.parentNode) {
    toast.parentNode.removeChild(toast);
  }
}

// 성공 토스트 표시 함수
function showSuccessToast(message) {
  const toastContainer = document.getElementById('toast-container') || createToastContainer();
  
  const toast = document.createElement('div');
  toast.className = 'toast show bg-success text-white';
  toast.innerHTML = `
    <div class="toast-body">
      <i class="fa-solid fa-check-circle me-2"></i>
      ${message}
    </div>
  `;
  
  toastContainer.appendChild(toast);
  
  // 3초 후 자동으로 숨기기
  setTimeout(() => {
    if (toast.parentNode) {
      toast.parentNode.removeChild(toast);
    }
  }, 3000);
}

// 에러 토스트 표시 함수
function showErrorToast(message) {
  const toastContainer = document.getElementById('toast-container') || createToastContainer();
  
  const toast = document.createElement('div');
  toast.className = 'toast show bg-danger text-white';
  toast.innerHTML = `
    <div class="toast-body">
      <i class="fa-solid fa-exclamation-triangle me-2"></i>
      ${message}
    </div>
  `;
  
  toastContainer.appendChild(toast);
  
  // 5초 후 자동으로 숨기기
  setTimeout(() => {
    if (toast.parentNode) {
      toast.parentNode.removeChild(toast);
    }
  }, 5000);
}

// 토스트 컨테이너 생성 함수
function createToastContainer() {
  const container = document.createElement('div');
  container.id = 'toast-container';
  container.className = 'toast-container position-fixed top-0 end-0 p-3';
  container.style.zIndex = '9999';
  document.body.appendChild(container);
  return container;
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM 로드됨, Bootstrap 대기 시작');
  waitForBootstrap();
  
  // 현재 페이지에 따른 메뉴 active 상태 설정
  setActiveMenuForCurrentPage(window.location.pathname);
});

// 현재 페이지에 따른 메뉴 active 상태 설정
function setActiveMenuForCurrentPage(currentPath) {
  console.log('현재 페이지 경로:', currentPath);
  
  // 모든 메뉴에서 active 클래스 제거
  document.querySelectorAll('.navbar-nav .nav-link, .dropdown-item').forEach(link => {
    link.classList.remove('active');
  });
  
  // 현재 페이지에 해당하는 메뉴 찾기
  const currentMenuItem = document.querySelector(`a[href="${currentPath}"]`);
  if (currentMenuItem) {
    console.log('현재 페이지 메뉴 발견:', currentMenuItem.textContent.trim());
    
    // 클릭된 메뉴에 active 상태 설정
    currentMenuItem.classList.add('active');
    
    // 드롭다운 메뉴인 경우 상위 메뉴도 active
    if (currentMenuItem.classList.contains('dropdown-item')) {
      const parentDropdown = currentMenuItem.closest('.dropdown');
      if (parentDropdown) {
        const parentToggle = parentDropdown.querySelector('.dropdown-toggle');
        if (parentToggle) {
          parentToggle.classList.add('active');
          console.log('상위 드롭다운 토글 active 상태 설정됨:', parentToggle.textContent.trim());
        }
      }
    }
    
    console.log('현재 페이지 메뉴 active 상태 설정 완료');
  } else {
    console.log('현재 페이지에 해당하는 메뉴를 찾을 수 없음');
  }
}
</script>

<style>
body { 
  background: linear-gradient(135deg, #f8fafc 0%, #e2eafc 100%);
  min-height: 100vh;
}

/* 브랜드 스타일 */
.brand-logo {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 0.75rem;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.brand-text small {
  font-size: 0.75rem;
  font-weight: 500;
}

/* 네비게이션 스타일 */
.navbar-nav .nav-link {
  color: #495057;
  font-weight: 500;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  transition: all 0.2s ease;
  margin: 0 0.25rem;
}

.navbar-nav .nav-link:hover {
  color: #667eea;
  background-color: rgba(102, 126, 234, 0.1);
  transform: translateY(-1px);
}

.navbar-nav .nav-link.active {
  color: #667eea;
  background-color: rgba(102, 126, 234, 0.1);
}

 /* 하위 메뉴 active 상태 스타일 */
 .dropdown-item.active {
   color: #667eea !important;
   background-color: rgba(102, 126, 234, 0.1) !important;
   font-weight: 600;
 }

/* 드롭다운 스타일 */
.dropdown-menu {
  border: none;
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  border-radius: 12px;
  padding: 0.5rem 0;
  min-width: 220px;
  border: 1px solid rgba(0,0,0,0.05);
  display: none; /* 기본적으로 숨김 */
  position: absolute;
  z-index: 9999; /* 높은 z-index로 다른 요소 위에 표시 */
  background: white;
  margin-top: 0.5rem;
  transition: opacity 0.15s ease-in-out, transform 0.15s ease-in-out;
  opacity: 0;
  transform: translateY(-10px);
}

.dropdown-menu.show {
  display: block !important; /* show 클래스가 있을 때 강제로 표시 */
  opacity: 1 !important;
  visibility: visible !important;
  transform: translateY(0) !important;
}

/* 드롭다운 토글 버튼 스타일 */
.dropdown-toggle::after {
  display: inline-block;
  margin-left: 0.255em;
  vertical-align: 0.255em;
  content: "";
  border-top: 0.3em solid;
  border-right: 0.3em solid transparent;
  border-bottom: 0;
  border-left: 0.3em solid transparent;
  transition: transform 0.15s ease-in-out;
}

/* 드롭다운이 열렸을 때 화살표 회전 */
.dropdown.show .dropdown-toggle::after {
  transform: rotate(180deg);
}

/* 드롭다운 아이템 스타일 */
.dropdown-item {
  padding: 0.75rem 1rem;
  color: #495057;
  transition: all 0.2s ease;
  border-radius: 0;
  display: block;
  text-decoration: none;
  white-space: nowrap;
  position: relative;
}

.dropdown-item:hover {
  background-color: #f8f9fa;
  color: #667eea;
  transform: translateX(5px);
}

.dropdown-item:active {
  background-color: #667eea;
  color: white;
}

/* 드롭다운 헤더 스타일 */
.dropdown-header {
  color: #6c757d;
  font-weight: 600;
  font-size: 0.875rem;
  padding: 0.5rem 1rem;
  margin-bottom: 0.25rem;
  border-bottom: 1px solid #e9ecef;
}

/* 사용자 정보 스타일 */
.user-info {
  background: rgba(102, 126, 234, 0.05);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  border: 1px solid rgba(102, 126, 234, 0.1);
}

/* 버튼 스타일 */
.btn {
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-sm {
  padding: 0.5rem 1rem;
  font-size: 0.85rem;
}

/* 반응형 디자인 */
@media (max-width: 991.98px) {
  .navbar-collapse {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-top: 1rem;
  }
  
  .navbar-nav {
    gap: 0.5rem;
  }
  
  .navbar-nav .nav-link {
    margin: 0;
    padding: 0.75rem 1rem;
  }
  
  .user-actions {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .brand-text h2 {
    font-size: 1.5rem;
  }
  
  .brand-text small {
    display: none;
  }
}

@media (max-width: 575.98px) {
  .container-fluid {
    padding: 1rem;
  }
  
  .brand-logo {
    padding: 0.5rem;
  }
  
  .brand-logo i {
    font-size: 1.5rem;
  }
  
  .brand-text h2 {
    font-size: 1.25rem;
  }
}

/* 토스트 컨테이너 스타일 */
.toast-container {
  z-index: 9999;
}

.toast {
  min-width: 300px;
  border: none;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.toast.bg-info {
  background-color: #17a2b8 !important;
}

.toast.bg-success {
  background-color: #28a745 !important;
}

.toast.bg-danger {
  background-color: #dc3545 !important;
}

.toast-body {
  padding: 1rem;
  font-weight: 500;
}
</style> 