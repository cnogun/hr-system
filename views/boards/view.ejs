<!--
  íŒŒì¼ëª…: boards/view.ejs
  ëª©ì : ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸° í˜ì´ì§€
  ê¸°ëŠ¥:
  - ê²Œì‹œê¸€ ì œëª© ë° ë‚´ìš© í‘œì‹œ
  - ì‘ì„±ì ë° ì‘ì„±ì¼ í‘œì‹œ
  - ì²¨ë¶€íŒŒì¼ ë‹¤ìš´ë¡œë“œ
  - ëŒ“ê¸€ ëª©ë¡ ë° ì‘ì„±
  - ì¢‹ì•„ìš”/ì‹«ì–´ìš” ê¸°ëŠ¥
  - ì‹ ê³  ê¸°ëŠ¥
  - ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ (ê¶Œí•œë³„)
-->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title><%= post.title %> - <%= board.name %></title>
</head>
<body>
  <%- include('../header') %>
  
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <!-- ê²Œì‹œê¸€ í—¤ë” -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>
            <% if (board.type === 'notice') { %>
              <i class="fas fa-bullhorn text-danger"></i>
            <% } else if (board.type === 'free') { %>
              <i class="fas fa-comments text-primary"></i>
            <% } else { %>
              <i class="fas fa-users text-success"></i>
            <% } %>
            <%= board.name %>
          </h2>
          <div>
            <a href="/boards/<%= board._id %>" class="btn btn-secondary btn-sm">
              <i class="fas fa-arrow-left"></i> ëª©ë¡
            </a>
            <% if (session.userRole === 'admin' || post.author.toString() === session.userId) { %>
              <a href="/boards/<%= board._id %>/<%= post._id %>/edit" class="btn btn-warning btn-sm">
                <i class="fas fa-edit"></i> ìˆ˜ì •
              </a>
              <button class="btn btn-danger btn-sm" onclick="deletePost()">
                <i class="fas fa-trash"></i> ì‚­ì œ
              </button>
            <% } %>
          </div>
        </div>

        <% if (session.message) { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= session.message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
          <% delete session.message; %>
        <% } %>

        <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
        <div class="card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h4 class="mb-1">
                  <% if (post.isNotice) { %>
                    <span class="badge bg-danger me-2">ê³µì§€</span>
                  <% } %>
                  <%= post.title %>
                </h4>
                <div class="text-muted small">
                  <span><i class="fas fa-user"></i> <%= post.authorName %></span>
                  <span class="ms-3"><i class="fas fa-calendar"></i> <%= new Date(post.createdAt).toLocaleString() %></span>
                  <span class="ms-3"><i class="fas fa-eye"></i> <%= post.views %></span>
                  <% if (post.isAnonymous) { %>
                    <span class="badge bg-secondary ms-2">ìµëª…</span>
                  <% } %>
                </div>
              </div>
              <div class="text-end">
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-success btn-sm" onclick="toggleLike()">
                    <i class="fas fa-thumbs-up"></i> ğŸ‘ <span id="likeCount"><%= post.likes ? post.likes.length : 0 %></span>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" onclick="toggleDislike()">
                    <i class="fas fa-thumbs-down"></i> ğŸ‘ <span id="dislikeCount"><%= post.dislikes ? post.dislikes.length : 0 %></span>
                  </button>
                  <button class="btn btn-outline-warning btn-sm" onclick="showReportModal()">
                    <i class="fas fa-flag"></i> ì‹ ê³ 
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- íƒœê·¸ -->
            <% if (post.tags && post.tags.length > 0) { %>
              <div class="mb-3">
                <% post.tags.forEach(tag => { %>
                  <span class="badge bg-info me-1"><%= tag %></span>
                <% }); %>
              </div>
            <% } %>

            <!-- ì²¨ë¶€íŒŒì¼ -->
            <% if (post.attachments && post.attachments.length > 0) { %>
              <div class="mb-3">
                <h6><i class="fas fa-paperclip"></i> ì²¨ë¶€íŒŒì¼</h6>
                <% post.attachments.forEach(attachment => { %>
                  <div class="mb-1">
                    <a href="<%= attachment.path %>" class="text-decoration-none" target="_blank">
                      <i class="fas fa-file"></i> <%= attachment.originalName %>
                      <small class="text-muted">(<%= (attachment.size / 1024).toFixed(1) %>KB)</small>
                    </a>
                  </div>
                <% }); %>
              </div>
            <% } %>

            <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
            <div class="post-content">
              <%- post.content.replace(/\n/g, '<br>') %>
            </div>
          </div>
        </div>

        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-comments"></i> ëŒ“ê¸€ (<%= comments.length %>)</h5>
          </div>
          <div class="card-body">
            <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
            <form action="/boards/<%= board._id %>/<%= post._id %>/comment" method="POST" class="mb-4">
              <div class="mb-3">
                <textarea class="form-control" name="content" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="commentAnonymous" name="isAnonymous">
                  <label class="form-check-label" for="commentAnonymous">
                    ìµëª…ìœ¼ë¡œ ì‘ì„±
                  </label>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="fas fa-paper-plane"></i> ëŒ“ê¸€ ì‘ì„±
                </button>
              </div>
            </form>

            <!-- ëŒ“ê¸€ ëª©ë¡ -->
            <% if (comments.length > 0) { %>
              <% comments.forEach(comment => { %>
                <div class="border-bottom pb-3 mb-3">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <strong><%= comment.authorName %></strong>
                      <% if (comment.isAnonymous) { %>
                        <span class="badge bg-secondary ms-1">ìµëª…</span>
                      <% } %>
                      <small class="text-muted ms-2"><%= new Date(comment.createdAt).toLocaleString() %></small>
                    </div>
                    <% if (session.userRole === 'admin' || comment.author.toString() === session.userId) { %>
                      <form action="/boards/<%= board._id %>/<%= post._id %>/comment/<%= comment._id %>?_method=DELETE" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    <% } %>
                  </div>
                  <div class="mt-2">
                    <%= comment.content.replace(/\n/g, '<br>') %>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <div class="text-center text-muted py-4">
                <i class="fas fa-comments fa-2x mb-2"></i>
                <p>ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì‹ ê³  ëª¨ë‹¬ -->
  <div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ê²Œì‹œê¸€ ì‹ ê³ </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="reportForm">
            <div class="mb-3">
              <label class="form-label">ì‹ ê³  ì‚¬ìœ </label>
              <select class="form-select" name="reason" required>
                <option value="">ì‚¬ìœ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                <option value="spam">ìŠ¤íŒ¸/ê´‘ê³ ì„± ê²Œì‹œê¸€</option>
                <option value="inappropriate">ë¶€ì ì ˆí•œ ë‚´ìš©</option>
                <option value="harassment">ìš•ì„¤/ë¹„ë°©/ê´´ë¡­í˜</option>
                <option value="copyright">ì €ì‘ê¶Œ ì¹¨í•´</option>
                <option value="other">ê¸°íƒ€</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">ìƒì„¸ ì„¤ëª…</label>
              <textarea class="form-control" name="description" rows="3" placeholder="ì‹ ê³  ì‚¬ìœ ë¥¼ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-warning" onclick="submitReport()">ì‹ ê³ í•˜ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <%- include('../footer') %>

  <script>
    function deletePost() {
      if (confirm('ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/boards/<%= board._id %>/<%= post._id %>?_method=DELETE';
        document.body.appendChild(form);
        form.submit();
      }
    }

    function showReportModal() {
      const modal = new bootstrap.Modal(document.getElementById('reportModal'));
      modal.show();
    }

    function submitReport() {
      const form = document.getElementById('reportForm');
      const formData = new FormData(form);
      
      fetch('/boards/<%= board._id %>/<%= post._id %>/report', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
          bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
          form.reset();
        } else {
          alert(data.error || 'ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    }

    function toggleLike() {
      fetch('/boards/<%= board._id %>/<%= post._id %>/like', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=like'
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('likeCount').textContent = data.likes;
        document.getElementById('dislikeCount').textContent = data.dislikes;
      })
      .catch(error => console.error('Error:', error));
    }

    function toggleDislike() {
      fetch('/boards/<%= board._id %>/<%= post._id %>/like', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=dislike'
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('likeCount').textContent = data.likes;
        document.getElementById('dislikeCount').textContent = data.dislikes;
      })
      .catch(error => console.error('Error:', error));
    }
  </script>
</body>
</html> 