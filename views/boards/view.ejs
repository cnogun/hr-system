<!--
  ÌååÏùºÎ™Ö: boards/view.ejs
  Î™©Ï†Å: Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏Î≥¥Í∏∞ ÌéòÏù¥ÏßÄ
  Í∏∞Îä•:
  - Í≤åÏãúÍ∏Ä Ï†úÎ™© Î∞è ÎÇ¥Ïö© ÌëúÏãú
  - ÏûëÏÑ±Ïûê Î∞è ÏûëÏÑ±Ïùº ÌëúÏãú
  - Ï≤®Î∂ÄÌååÏùº Îã§Ïö¥Î°úÎìú
  - ÎåìÍ∏Ä Î™©Î°ù Î∞è ÏûëÏÑ±
  - Ï¢ãÏïÑÏöî/Ïã´Ïñ¥Ïöî Í∏∞Îä•
  - Ïã†Í≥† Í∏∞Îä•
  - ÏàòÏ†ï/ÏÇ≠Ï†ú Î≤ÑÌäº (Í∂åÌïúÎ≥Ñ)
-->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title><%= post.title %> - <%= board.name %></title>
</head>
<body>
  <%- include('../header') %>
  
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <!-- Í≤åÏãúÍ∏Ä Ìó§Îçî -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>
            <% if (board.type === 'notice') { %>
              <i class="fas fa-bullhorn text-danger"></i>
            <% } else if (board.type === 'free') { %>
              <i class="fas fa-comments text-primary"></i>
            <% } else { %>
              <i class="fas fa-users text-success"></i>
            <% } %>
            <%= board.name %>
          </h2>
          <div>
            <a href="/boards/<%= board._id %>" class="btn btn-secondary btn-sm">
              <i class="fas fa-arrow-left"></i> Î™©Î°ù
            </a>
            <% if (session.userRole === 'admin' || post.author.toString() === session.userId) { %>
              <a href="/boards/<%= board._id %>/<%= post._id %>/edit" class="btn btn-warning btn-sm">
                <i class="fas fa-edit"></i> ÏàòÏ†ï
              </a>
              <button class="btn btn-danger btn-sm" onclick="deletePost()">
                <i class="fas fa-trash"></i> ÏÇ≠Ï†ú
              </button>
            <% } %>
          </div>
        </div>

        <% if (session.message) { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= session.message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
          <% delete session.message; %>
        <% } %>

        <!-- Í≤åÏãúÍ∏Ä ÎÇ¥Ïö© -->
        <div class="card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h4 class="mb-1">
                  <% if (post.isNotice) { %>
                    <span class="badge bg-danger me-2">Í≥µÏßÄ</span>
                  <% } %>
                  <%= post.title %>
                </h4>
                <div class="text-muted small">
                  <span><i class="fas fa-user"></i> <%= post.authorName %></span>
                  <span class="ms-3"><i class="fas fa-calendar"></i> <%= new Date(post.createdAt).toLocaleString() %></span>
                  <span class="ms-3"><i class="fas fa-eye"></i> <%= post.views %></span>
                  <% if (post.isAnonymous) { %>
                    <span class="badge bg-secondary ms-2">ÏùµÎ™Ö</span>
                  <% } %>
                </div>
              </div>
              <div class="text-end">
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-success btn-sm" onclick="toggleLike()">
                    <i class="fas fa-thumbs-up"></i> üëç <span id="likeCount"><%= post.likes ? post.likes.length : 0 %></span>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" onclick="toggleDislike()">
                    <i class="fas fa-thumbs-down"></i> üëé <span id="dislikeCount"><%= post.dislikes ? post.dislikes.length : 0 %></span>
                  </button>
                  <button class="btn btn-outline-warning btn-sm" onclick="showReportModal()">
                    <i class="fas fa-flag"></i> Ïã†Í≥†
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- ÌÉúÍ∑∏ -->
            <% if (post.tags && post.tags.length > 0) { %>
              <div class="mb-3">
                <% post.tags.forEach(tag => { %>
                  <span class="badge bg-info me-1"><%= tag %></span>
                <% }); %>
              </div>
            <% } %>

            <!-- Ï≤®Î∂ÄÌååÏùº -->
            <% if (post.attachments && post.attachments.length > 0) { %>
              <div class="mb-3">
                <h6><i class="fas fa-paperclip"></i> Ï≤®Î∂ÄÌååÏùº</h6>
                <% post.attachments.forEach(attachment => { %>
                  <div class="mb-1">
                    <a href="<%= attachment.path %>" class="text-decoration-none" target="_blank">
                      <i class="fas fa-file"></i> <%= attachment.originalName %>
                      <small class="text-muted">(<%= (attachment.size / 1024).toFixed(1) %>KB)</small>
                    </a>
                  </div>
                <% }); %>
              </div>
            <% } %>

            <!-- Í≤åÏãúÍ∏Ä ÎÇ¥Ïö© -->
            <div class="post-content">
              <%- post.content.replace(/\n/g, '<br>') %>
            </div>
          </div>
        </div>

        <!-- ÎåìÍ∏Ä ÏÑπÏÖò -->
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-comments"></i> ÎåìÍ∏Ä (<%= comments.length %>)</h5>
          </div>
          <div class="card-body">
            <!-- ÎåìÍ∏Ä ÏûëÏÑ± Ìèº -->
            <form action="/boards/<%= board._id %>/<%= post._id %>/comment" method="POST" class="mb-4">
              <div class="mb-3">
                <textarea class="form-control" name="content" rows="3" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." required></textarea>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="commentAnonymous" name="isAnonymous">
                  <label class="form-check-label" for="commentAnonymous">
                    ÏùµÎ™ÖÏúºÎ°ú ÏûëÏÑ±
                  </label>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="fas fa-paper-plane"></i> ÎåìÍ∏Ä ÏûëÏÑ±
                </button>
              </div>
            </form>

            <!-- ÎåìÍ∏Ä Î™©Î°ù -->
            <% if (comments.length > 0) { %>
              <% comments.forEach(comment => { %>
                <div class="border-bottom pb-3 mb-3">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <strong><%= comment.authorName %></strong>
                      <% if (comment.isAnonymous) { %>
                        <span class="badge bg-secondary ms-1">ÏùµÎ™Ö</span>
                      <% } %>
                      <small class="text-muted ms-2"><%= new Date(comment.createdAt).toLocaleString() %></small>
                    </div>
                    <% if (session.userRole === 'admin' || comment.author.toString() === session.userId) { %>
                      <form action="/boards/<%= board._id %>/<%= post._id %>/comment/<%= comment._id %>?_method=DELETE" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    <% } %>
                  </div>
                  <div class="mt-2">
                    <%= comment.content.replace(/\n/g, '<br>') %>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <div class="text-center text-muted py-4">
                <i class="fas fa-comments fa-2x mb-2"></i>
                <p>Ï≤´ Î≤àÏß∏ ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ïã†Í≥† Î™®Îã¨ -->
  <div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Í≤åÏãúÍ∏Ä Ïã†Í≥†</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="reportForm">
            <div class="mb-3">
              <label class="form-label">Ïã†Í≥† ÏÇ¨Ïú†</label>
              <select class="form-select" name="reason" required>
                <option value="">ÏÇ¨Ïú†Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                <option value="spam">Ïä§Ìå∏/Í¥ëÍ≥†ÏÑ± Í≤åÏãúÍ∏Ä</option>
                <option value="inappropriate">Î∂ÄÏ†ÅÏ†àÌïú ÎÇ¥Ïö©</option>
                <option value="harassment">ÏöïÏÑ§/ÎπÑÎ∞©/Í¥¥Î°≠Ìûò</option>
                <option value="copyright">Ï†ÄÏûëÍ∂å Ïπ®Ìï¥</option>
                <option value="other">Í∏∞ÌÉÄ</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">ÏÉÅÏÑ∏ ÏÑ§Î™Ö</label>
              <textarea class="form-control" name="description" rows="3" placeholder="Ïã†Í≥† ÏÇ¨Ïú†Î•º ÏûêÏÑ∏Ìûà ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
          <button type="button" class="btn btn-warning" onclick="submitReport()">Ïã†Í≥†ÌïòÍ∏∞</button>
        </div>
      </div>
    </div>
  </div>

  <%- include('../footer') %>

  <script>
    function deletePost() {
      if (confirm('Í≤åÏãúÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/boards/<%= board._id %>/<%= post._id %>?_method=DELETE';
        document.body.appendChild(form);
        form.submit();
      }
    }

    function showReportModal() {
      const modal = new bootstrap.Modal(document.getElementById('reportModal'));
      modal.show();
    }

    function submitReport() {
      const form = document.getElementById('reportForm');
      const formData = new FormData(form);
      
      fetch('/boards/<%= board._id %>/<%= post._id %>/report', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Ïã†Í≥†Í∞Ä Ï†ëÏàòÎêòÏóàÏäµÎãàÎã§.');
          bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
          form.reset();
        } else {
          alert(data.error || 'Ïã†Í≥† Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Ïã†Í≥† Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      });
    }

    function toggleLike() {
      fetch('/boards/<%= board._id %>/<%= post._id %>/like', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=like'
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('likeCount').textContent = data.likes;
        document.getElementById('dislikeCount').textContent = data.dislikes;
      })
      .catch(error => console.error('Error:', error));
    }

    function toggleDislike() {
      fetch('/boards/<%= board._id %>/<%= post._id %>/like', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=dislike'
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('likeCount').textContent = data.likes;
        document.getElementById('dislikeCount').textContent = data.dislikes;
      })
      .catch(error => console.error('Error:', error));
    }
  </script>
</body>
</html> 