<%- include('header') %>

<style>
  /* 근태 관리 페이지 모바일 최적화 스타일 */
  @media (max-width: 768px) {
    .container {
      padding: 0.5rem;
    }
    
    .d-flex.justify-content-between {
      flex-direction: column;
      gap: 1rem;
      align-items: stretch;
    }
    
    .d-flex.justify-content-between .d-flex {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .d-flex.justify-content-between .btn {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    .card {
      margin-bottom: 1rem;
      border-radius: 12px;
    }
    
    .card-body {
      padding: 1rem;
    }
    
    .card-header {
      padding: 1rem;
      border-radius: 12px 12px 0 0;
    }
    
    .form-control,
    .form-select {
      font-size: 0.9rem;
      padding: 0.75rem 0.5rem;
    }
    
    .btn {
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      border-radius: 8px;
    }
    
    .table-responsive {
      border-radius: 8px;
      margin-bottom: 0;
    }
    
    .table thead th {
      padding: 0.75rem 0.5rem;
      font-size: 0.75rem;
      white-space: nowrap;
    }
    
    .table tbody td {
      padding: 0.75rem 0.5rem;
      font-size: 0.8rem;
    }
    
    .badge {
      font-size: 0.7rem;
      padding: 0.375rem 0.5rem;
    }
    
    .form-label {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    
    .row.g-3 {
      margin: 0;
    }
    
    .col-auto {
      padding: 0 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .col-auto .btn {
      width: 100%;
    }
    
    .table-responsive {
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: #667eea #f1f1f1;
    }
    
    .table-responsive::-webkit-scrollbar {
      height: 6px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 3px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
      background: #5a6fd8;
    }
  }
  
  /* 작은 모바일 화면 최적화 */
  @media (max-width: 576px) {
    .container {
      padding: 0.25rem;
    }
    
    .card-body {
      padding: 0.75rem;
    }
    
    .card-header {
      padding: 0.75rem;
    }
    
    .form-control,
    .form-select {
      font-size: 0.85rem;
      padding: 0.5rem 0.5rem;
    }
    
    .btn {
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
    }
    
    .table thead th {
      padding: 0.5rem 0.25rem;
      font-size: 0.7rem;
    }
    
    .table tbody td {
      padding: 0.5rem 0.25rem;
      font-size: 0.75rem;
    }
    
    .badge {
      font-size: 0.65rem;
      padding: 0.25rem 0.375rem;
    }
    
    .form-label {
      font-size: 0.85rem;
    }
    
    .col-auto {
      padding: 0 0.25rem;
      margin-bottom: 0.5rem;
    }
  }
  
  /* 태블릿 최적화 */
  @media (min-width: 769px) and (max-width: 1024px) {
    .card-body {
      padding: 1.5rem;
    }
    
    .card-header {
      padding: 1.25rem;
    }
    
    .form-control,
    .form-select {
      padding: 0.875rem 0.75rem;
    }
    
    .btn {
      padding: 0.875rem 1.25rem;
    }
    
    .table thead th {
      padding: 0.875rem 0.625rem;
    }
    
    .table tbody td {
      padding: 0.875rem 0.625rem;
    }
  }
  
  /* 터치 디바이스 최적화 */
  @media (hover: none) and (pointer: coarse) {
    .btn {
      min-height: 44px;
    }
    
    .form-control,
    .form-select {
      min-height: 44px;
    }
    
    .table tbody tr {
      min-height: 44px;
    }
    
    .badge {
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  }
  
  /* 모바일에서 테이블 가로 스크롤 안내 */
  @media (max-width: 768px) {
    .table-scroll-hint {
      background: #e3f2fd;
      color: #1976d2;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
      font-size: 0.85rem;
      border: 1px solid #bbdefb;
    }
    
    .table-scroll-hint i {
      margin-right: 0.5rem;
    }
  }
</style>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <!-- 페이지 헤더 -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="mb-1">
            <i class="fa-solid fa-clock me-2 text-primary"></i>근태 관리
          </h2>
          <p class="text-muted mb-0">직원들의 일일 근태를 입력하고 관리합니다.</p>
        </div>
        <div class="d-flex gap-2">
          <div class="d-flex align-items-center gap-2">
            <input type="date" id="attendanceDate" class="form-control" value="<%= today %>">
            <span id="selectedDayOfWeek" class="badge bg-secondary fs-6 px-3 py-2"></span>
          </div>
          <button class="btn btn-primary" onclick="loadAttendanceData()">
            <i class="fa-solid fa-search me-1"></i>조회
          </button>
          <button class="btn btn-info" onclick="autoSetAttendance()">
            <i class="fa-solid fa-robot me-1"></i>근태 자동 입력
          </button>
        </div>
      </div>

        <!-- 이번주 팀 근무 형태 -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">
              <i class="fa-solid fa-users me-2"></i><span id="currentWeekInfo">이번주 팀 근무 형태</span>
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <div class="text-center p-3 border rounded">
                  <h6 class="text-primary">보안1팀</h6>
                  <span class="badge bg-success fs-6" id="team1Schedule">초야</span>
                  <small class="d-block text-muted mt-1">14:00~22:00</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center p-3 border rounded">
                  <h6 class="text-primary">보안2팀</h6>
                  <span class="badge bg-warning fs-6" id="team2Schedule">심야</span>
                  <small class="d-block text-muted mt-1">22:00~06:00</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center p-3 border rounded">
                  <h6 class="text-primary">보안3팀</h6>
                  <span class="badge bg-info fs-6" id="team3Schedule">주간</span>
                  <small class="d-block text-muted mt-1">06:00~14:00</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 부서별 필터 -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <form method="GET" class="row g-3 align-items-center">
              <div class="col-auto">
                <label for="departmentFilter" class="form-label fw-bold">부서 선택:</label>
              </div>
              <div class="col-auto">
                <select name="department" id="departmentFilter" class="form-select" onchange="this.form.submit()">
                  <option value="">전체 부서</option>
                  <% if (allDepartments && allDepartments.length > 0) { %>
                    <% allDepartments.forEach(dept => { %>
                      <option value="<%= dept %>" <%= dept === selectedDepartment ? 'selected' : '' %>><%= dept %></option>
                    <% }); %>
                  <% } %>
                </select>
              </div>
              <div class="col-auto">
                <button type="submit" class="btn btn-outline-primary">
                  <i class="fa-solid fa-filter me-1"></i>필터 적용
                </button>
              </div>
            </form>
        </div>
      </div>

      <!-- 모바일 테이블 스크롤 안내 -->
      <div class="table-scroll-hint d-md-none">
        <i class="fa-solid fa-arrows-left-right"></i>
        테이블을 좌우로 스크롤하여 모든 정보를 확인하세요
      </div>

      <!-- 근태 입력 폼 -->
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fa-solid fa-edit me-2"></i>근태 입력
          </h5>
        </div>
        <div class="card-body p-0">
          <form id="attendanceForm">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                      <th style="width: 100px;">이름</th>
                      <th style="width: 80px;">부서</th>
                      <th style="width: 80px;">직급</th>
                      <th style="width: 130px;">근태 상태</th>
                      <th style="width: 80px;">출근 시간</th>
                      <th style="width: 80px;">퇴근 시간</th>
                      <th style="width: 70px;">기본</th>
                      <th style="width: 70px;">연장</th>
                      <th style="width: 70px;">특근</th>
                      <th style="width: 70px;">특연</th>
                      <th style="width: 70px;">야간</th>
                      <th style="width: 80px;">총시간</th>
                      <th style="width: 200px;">비고</th>
                  </tr>
                </thead>
                <tbody>
                  <% employees.forEach(function(employee) { %>
                  <tr>
                    <td class="align-middle">
                          <strong>
                            <%= employee.name %>
                          </strong>
                    </td>
                    <td class="align-middle">
                          <span class="badge bg-secondary">
                            <%= employee.department || '부서미정' %>
                          </span>
                    </td>
                    <td class="align-middle">
                          <span class="badge bg-info">
                            <%= employee.position || '직급미정' %>
                          </span>
                    </td>
                    <td class="align-middle">
                          <select class="form-select form-select-sm" name="<%= employee._id %>_status"
                            onchange="toggleTimeInputs('<%= employee._id %>')">
                        <option value="">선택</option>
                            <option value="출근(주)">출근(주)</option>
                            <option value="출근(초)">출근(초)</option>
                            <option value="출근(심)">출근(심)</option>
                            <option value="출근(주특)">출근(주특)</option>
                            <option value="출근(야특)">출근(야특)</option>
                            <option value="출근(사무)">출근(사무)</option>
                            <option value="정기휴무">정기휴무</option>
                            <option value="경조휴가">경조휴가</option>
                            <option value="월차휴가">월차휴가</option>
                            <option value="연차휴가">연차휴가</option>
                            <option value="지각">지각</option>
                            <option value="조퇴">조퇴</option>
                            <option value="반차">반차</option>
                        <option value="병가">병가</option>
                            <option value="산재">산재</option>
                        <option value="출장">출장</option>
                        <option value="결근">결근</option>
                      </select>
                    </td>
                    <td class="align-middle">
                          <input type="time" class="form-control form-control-sm" name="<%= employee._id %>_checkIn"
                            onchange="calculateNightTime('<%= employee._id %>')" disabled>
                        </td>
                        <td class="align-middle">
                          <input type="time" class="form-control form-control-sm" name="<%= employee._id %>_checkOut"
                            onchange="calculateNightTime('<%= employee._id %>')" disabled>
                        </td>
                        <td class="align-middle">
                          <input type="number" class="form-control form-control-sm time-input"
                            name="<%= employee._id %>_basic" placeholder="0" min="0" step="0.5"
                            onchange="calculateTotalTime('<%= employee._id %>')" disabled>
                        </td>
                        <td class="align-middle">
                          <input type="number" class="form-control form-control-sm time-input"
                            name="<%= employee._id %>_overtime" placeholder="0" min="0" step="0.5"
                            onchange="calculateTotalTime('<%= employee._id %>')" disabled>
                        </td>
                        <td class="align-middle">
                          <input type="number" class="form-control form-control-sm time-input"
                            name="<%= employee._id %>_special" placeholder="0" min="0" step="0.5"
                            onchange="calculateTotalTime('<%= employee._id %>')" disabled>
                        </td>
                        <td class="align-middle">
                          <input type="number" class="form-control form-control-sm time-input"
                            name="<%= employee._id %>_specialOvertime" placeholder="0" min="0" step="0.5"
                            onchange="calculateTotalTime('<%= employee._id %>')" disabled>
                        </td>
                        <td class="align-middle">
                          <input type="number" class="form-control form-control-sm time-input"
                            name="<%= employee._id %>_night" placeholder="0" min="0" step="0.5"
                            onchange="calculateTotalTime('<%= employee._id %>')" disabled>
                    </td>
                    <td class="align-middle">
                          <input type="number" class="form-control form-control-sm" name="<%= employee._id %>_totalTime"
                            placeholder="0" min="0" step="0.5" readonly style="background-color: #f8f9fa;">
                    </td>
                    <td class="align-middle">
                          <input type="text" class="form-control form-control-sm" name="<%= employee._id %>_note"
                            placeholder="" style="min-width: 180px; font-size: 0.875rem;">
                    </td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </form>
        </div>
        <div class="card-footer">
          <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted">
                <small>총 <strong>
                    <%= employees.length %>
                  </strong>명의 직원</small>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary" onclick="resetForm()">
                <i class="fa-solid fa-undo me-1"></i>초기화
              </button>
              <button class="btn btn-success" onclick="saveAttendance()">
                <i class="fa-solid fa-save me-1"></i>저장
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 저장 결과 알림 -->
      <div id="saveResult" class="alert mt-3" style="display: none;"></div>
    </div>
  </div>
</div>

<script>
    // 근태 상태에 따라 시간 입력 필드 활성화/비활성화 및 기본값 설정
function toggleTimeInputs(employeeId) {
  // employeeId 유효성 검사 추가
  if (!employeeId || typeof employeeId !== 'string') {
    console.error('toggleTimeInputs: 유효하지 않은 employeeId:', employeeId);
    return;
  }
  
  console.log('toggleTimeInputs 호출됨, employeeId:', employeeId);
  
  const statusSelect = document.querySelector(`select[name="${employeeId}_status"]`);
  const checkInInput = document.querySelector(`input[name="${employeeId}_checkIn"]`);
  const checkOutInput = document.querySelector(`input[name="${employeeId}_checkOut"]`);
  
  // CSS 선택자 오류 방지를 위한 안전한 쿼리
  let timeInputs = [];
  try {
    timeInputs = document.querySelectorAll(`input[name^="${employeeId}_"][class*="time-input"]`);
  } catch (error) {
    console.error('timeInputs 쿼리 오류:', error);
    timeInputs = [];
  }
  
  const basicInput = document.querySelector(`input[name="${employeeId}_basic"]`);
  const specialInput = document.querySelector(`input[name="${employeeId}_special"]`);
  const specialOvertimeInput = document.querySelector(`input[name="${employeeId}_specialOvertime"]`);
  const nightInput = document.querySelector(`input[name="${employeeId}_night"]`);

      // 모든 시간 입력 필드 초기화
      checkInInput.value = '';
      checkOutInput.value = '';
      timeInputs.forEach(input => input.value = '');
      
      // 각 근태 상태별 처리
      switch (statusSelect.value) {
        case '출근(주)':
          checkInInput.disabled = false;
          checkOutInput.disabled = false;
          timeInputs.forEach(input => input.disabled = false);
          checkInInput.value = '06:00';
          checkOutInput.value = '14:00';
          if (basicInput) basicInput.value = '8';
          // 비고란 자동 설정
          const noteInput = document.querySelector(`input[name="${employeeId}_note"]`);
          if (noteInput) noteInput.value = '평일주간';
          break;
          
        case '출근(초)':
          checkInInput.disabled = false;
          checkOutInput.disabled = false;
          timeInputs.forEach(input => input.disabled = false);
          checkInInput.value = '14:00';
          checkOutInput.value = '22:00';
          if (basicInput) basicInput.value = '8';
          // 비고란 자동 설정
          const noteInput2 = document.querySelector(`input[name="${employeeId}_note"]`);
          if (noteInput2) noteInput2.value = '평일 초야';
          break;
          
        case '출근(심)':
          checkInInput.disabled = false;
          checkOutInput.disabled = false;
          timeInputs.forEach(input => input.disabled = false);
          checkInInput.value = '22:00';
          checkOutInput.value = '06:00';
          if (basicInput) basicInput.value = '8';
          if (nightInput) {
            nightInput.value = '8';
            console.log('출근(심) 상태에서 야간시간 즉시 설정: 4시간 (가중치 적용)');
          }
          // 비고란 자동 설정
          const noteInput3 = document.querySelector(`input[name="${employeeId}_note"]`);
          if (noteInput3) noteInput3.value = '평일 심야';
          // 심야 근무시 야간시간 강제 설정 (이중 보장)
          setTimeout(() => {
            if (nightInput) {
              nightInput.value = '8';
              console.log('출근(심) 상태에서 야간시간 강제 설정: 4시간 (가중치 적용)');
            }
            calculateTotalTime(employeeId);
          }, 100);
          
          // 추가 강제 설정 (500ms 후)
          setTimeout(() => {
            if (nightInput) {
              nightInput.value = '8';
              console.log('출근(심) 상태에서 야간시간 추가 강제 설정: 4시간 (가중치 적용)');
            }
            calculateTotalTime(employeeId);
          }, 500);
          break;
          
        case '출근(사무)':
          checkInInput.disabled = false;
          checkOutInput.disabled = false;
          timeInputs.forEach(input => input.disabled = false);
          checkInInput.value = '06:00';
          checkOutInput.value = '18:00';
          if (basicInput) basicInput.value = '12';
          // 비고란 자동 설정
          const noteInput4 = document.querySelector(`input[name="${employeeId}_note"]`);
          if (noteInput4) noteInput4.value = '사무근무';
          break;
          
        case '출근(주특)':
          checkInInput.disabled = false;
          checkOutInput.disabled = false;
          timeInputs.forEach(input => input.disabled = false);
          checkInInput.value = '06:00';
          checkOutInput.value = '18:00';
          if (basicInput) basicInput.value = '8';
          if (specialInput) specialInput.value = '8';
          if (specialOvertimeInput) specialOvertimeInput.value = '4';
          // 비고란 자동 설정
          const noteInput5 = document.querySelector(`input[name="${employeeId}_note"]`);
          if (noteInput5) noteInput5.value = '주간특근';
          break;
          
        case '출근(야특)':
          checkInInput.disabled = false;
          checkOutInput.disabled = false;
          timeInputs.forEach(input => input.disabled = false);
          checkInInput.value = '18:00';
          checkOutInput.value = '06:00';
          if (basicInput) basicInput.value = '8';
          if (specialInput) specialInput.value = '8';
          if (specialOvertimeInput) specialOvertimeInput.value = '4';
          if (nightInput) nightInput.value = '8';
          // 비고란 자동 설정
          const noteInput6 = document.querySelector(`input[name="${employeeId}_note"]`);
          if (noteInput6) noteInput6.value = '야간특근';
          // 주말 야간 근무시 야간시간 강제 설정
          setTimeout(() => {
            if (nightInput) {
              nightInput.value = '8';
              console.log('출근(야특) 상태에서 야간시간 강제 설정: 4시간 (가중치 적용)');
            }
            calculateTotalTime(employeeId);
          }, 100);
          break;

        case '경조휴가':
        case '월차휴가':
        case '연차휴가':
        case '병가':
          checkInInput.disabled = true;
          checkOutInput.disabled = true;
          timeInputs.forEach(input => input.disabled = true);
          if (basicInput) {
            basicInput.disabled = false;
            basicInput.value = '8';
          }
          // 비고란 자동 설정
          const noteInput7 = document.querySelector(`input[name="${employeeId}_note"]`);
          if (noteInput7) {
            switch(statusSelect.value) {
              case '경조휴가': noteInput7.value = '경조 휴가'; break;
              case '월차휴가': noteInput7.value = '월차 휴가'; break;
              case '연차휴가': noteInput7.value = '연차 휴가'; break;
              case '병가': noteInput7.value = '병가'; break;
            }
          }
          break;

        case '반차':
          checkInInput.disabled = false;
          checkOutInput.disabled = false;
          timeInputs.forEach(input => input.disabled = true);
          if (basicInput) {
            basicInput.disabled = false;
            basicInput.value = '4';
          }
          if (nightInput) nightInput.disabled = false;
          // 비고란 자동 설정
          const noteInput8 = document.querySelector(`input[name="${employeeId}_note"]`);
          if (noteInput8) noteInput8.value = '반차';
          break;
          
        case '지각':
        case '조퇴':
          checkInInput.disabled = false;
          checkOutInput.disabled = false;
          timeInputs.forEach(input => input.disabled = false);
          // 비고란 자동 설정
          const noteInput9 = document.querySelector(`input[name="${employeeId}_note"]`);
          if (noteInput9) {
            switch(statusSelect.value) {
              case '지각': noteInput9.value = '지각'; break;
              case '조퇴': noteInput9.value = '조퇴'; break;
            }
          }
          break;
          
        default:
          // 산재, 출장, 결근 등
          checkInInput.disabled = true;
          checkOutInput.disabled = true;
          timeInputs.forEach(input => input.disabled = true);
          // 비고란 자동 설정
          const noteInput10 = document.querySelector(`input[name="${employeeId}_note"]`);
          if (noteInput10) {
            switch(statusSelect.value) {
              case '산재': noteInput10.value = '산재'; break;
              case '출장': noteInput10.value = '출장'; break;
              case '결근': noteInput10.value = '결근'; break;
              case '정기휴무': noteInput10.value = '정기 휴무'; break;
              case '휴무': noteInput10.value = '휴무'; break;
              default: noteInput10.value = statusSelect.value; break;
            }
          }
          break;
      }
      
      // 야간시간 자동 계산 (강제 실행) - 심야 근무시에는 야간시간 계산 건너뛰기
      setTimeout(() => {
        console.log('근태 상태 변경 후 야간시간 계산 실행');
        // 심야 근무 상태인 경우 야간시간은 이미 설정되어 있으므로 건너뛰기
        const statusSelect = document.querySelector(`select[name="${employeeId}_status"]`);
        if (statusSelect && statusSelect.value === '출근(심)') {
          console.log('출근(심) 상태: 야간시간 계산 건너뛰고 총시간만 계산');
          calculateTotalTime(employeeId);
        } else {
          calculateNightTime(employeeId);
          calculateTotalTime(employeeId);
        }
      }, 500);
    }

    // 총시간 자동 계산 (가중치가 이미 적용된 값들을 단순 합계)
    function calculateTotalTime(employeeId) {
      const basic = parseFloat(document.querySelector(`input[name="${employeeId}_basic"]`).value) || 0;
      const overtime = parseFloat(document.querySelector(`input[name="${employeeId}_overtime"]`).value) || 0;
      const special = parseFloat(document.querySelector(`input[name="${employeeId}_special"]`).value) || 0;
      const specialOvertime = parseFloat(document.querySelector(`input[name="${employeeId}_specialOvertime"]`).value) || 0;
      const night = parseFloat(document.querySelector(`input[name="${employeeId}_night"]`).value) || 0;
      
      // 총시간 계산 (가중치 적용)
      // 기본시간 + 연장시간 + (특근시간 × 1.5) + (특연시간 × 2) + (야간시간 × 0.5)
      const totalTime = basic + overtime + (special * 1.5) + (specialOvertime * 2) + (night * 0.5);
      
      const totalInput = document.querySelector(`input[name="${employeeId}_totalTime"]`);
      if (totalInput) {
        totalInput.value = Math.floor(totalTime);
      }
    }

    // 야간시간 자동 계산 (22:00~06:00)
    function calculateNightTime(employeeId) {
      const checkInInput = document.querySelector(`input[name="${employeeId}_checkIn"]`);
      const checkOutInput = document.querySelector(`input[name="${employeeId}_checkOut"]`);
      const nightInput = document.querySelector(`input[name="${employeeId}_night"]`);
      
      if (!checkInInput || !checkOutInput || !nightInput) return;
      
      const checkIn = checkInInput.value;
      const checkOut = checkOutInput.value;
      
      if (!checkIn || !checkOut) return;
      
      // 야간시간 계산 (22:00~06:00)
      const [checkInHour, checkInMin] = checkIn.split(':').map(Number);
      const [checkOutHour, checkOutMin] = checkOut.split(':').map(Number);
      
      let nightTime = 0;
      
      console.log(`야간시간 계산 - 직원ID: ${employeeId}, 출근: ${checkInHour}:${checkInMin}, 퇴근: ${checkOutHour}:${checkOutMin}`);
      console.log(`파싱된 시간 - 출근시간: ${checkInHour}시, 퇴근시간: ${checkOutHour}시`);
      
      // 야간 근무 감지 (22:00~06:00) - 원본 시간으로 설정
      if (checkInHour >= 18 && checkOutHour <= 6) {
        // 야간 특근: 18:00~06:00 (다음날) - 야간시간 8시간 (원본)
        nightTime = 8;
        console.log('야간 특근 감지: 야간시간 8시간으로 설정 (원본)');
      } else if (checkInHour >= 22 && checkOutHour <= 6) {
        // 심야 정상근무: 22:00~06:00 - 야간시간 8시간 (원본)
        nightTime = 8;
        console.log('심야 근무 감지: 야간시간 8시간으로 설정 (원본)');
      } else if (checkInHour >= 22 || checkOutHour <= 6) {
        // 22:00~06:00 구간에 해당하는 경우 - 야간시간 8시간 (원본)
        nightTime = 8;
        console.log('일반 야간시간: 야간시간 8시간으로 설정 (원본)');
      } else if (checkInHour >= 18 && checkOutHour <= 23) {
        // 18:00~23:59 구간 (야간 특근의 시작 부분) - 야간시간 6시간 (원본)
        nightTime = 6;
        console.log('야간 특근 시작 부분 감지: 야간시간 6시간으로 설정 (원본)');
      }
      
      console.log(`최종 야간시간: ${nightTime}시간 (원본 값)`);
      nightInput.value = nightTime;
      
      // 총시간 재계산
      calculateTotalTime(employeeId);
    }

    // 모든 필드 초기화
    function clearAllFields() {
      // 모든 시간 입력 필드 비활성화 및 초기화
      const timeInputs = document.querySelectorAll('input[type="time"], input[class*="time-input"]');
      timeInputs.forEach(input => {
        input.disabled = true;
        input.value = '';
      });

      // 총시간 필드 초기화
      const totalInputs = document.querySelectorAll('input[name$="_totalTime"]');
      totalInputs.forEach(input => {
        input.value = '';
      });

      // 상태 선택 초기화
      const statusSelects = document.querySelectorAll('select[name$="_status"]');
      statusSelects.forEach(select => {
        select.value = '';
      });

      // 비고 필드 초기화
      const noteInputs = document.querySelectorAll('input[name$="_note"]');
      noteInputs.forEach(input => {
        input.value = '';
      });
    }

    // 폼 초기화
    function resetForm() {
      if (confirm('모든 입력 내용을 초기화하시겠습니까?')) {
        document.getElementById('attendanceForm').reset();
        clearAllFields();
      }
    }

// 근태 데이터 저장
async function saveAttendance() {
  try {
    const date = document.getElementById('attendanceDate').value;
    const form = document.getElementById('attendanceForm');
    const formData = new FormData(form);
    
    const attendanceData = {};
    
    // 폼 데이터를 구조화된 객체로 변환
    for (const [key, value] of formData.entries()) {
      const [employeeId, field] = key.split('_');
      
      if (!attendanceData[employeeId]) {
        attendanceData[employeeId] = {};
      }
      
          attendanceData[employeeId][field] = value;
    }
    
    // API 호출
    const response = await fetch('/attendance/save', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        date: date,
        attendanceData: attendanceData
      })
    });
    
    const result = await response.json();
    
    // 결과 표시
    const resultDiv = document.getElementById('saveResult');
    resultDiv.style.display = 'block';
    
    if (result.success) {
      resultDiv.className = 'alert alert-success mt-3';
      resultDiv.innerHTML = `
        <i class="fa-solid fa-check-circle me-2"></i>
        ${result.message}
      `;
    } else {
      resultDiv.className = 'alert alert-danger mt-3';
      resultDiv.innerHTML = `
        <i class="fa-solid fa-exclamation-triangle me-2"></i>
        ${result.message}
      `;
    }
    
    // 3초 후 알림 숨기기
    setTimeout(() => {
      resultDiv.style.display = 'none';
    }, 3000);
    
  } catch (error) {
    console.error('근태 저장 오류:', error);
    alert('근태 저장 중 오류가 발생했습니다.');
  }
}

// 시간 형식을 HH:mm으로 변환하는 함수
function formatTimeForInput(timeValue) {
  if (!timeValue || timeValue === '') return '';
  
  // 숫자만 있는 경우 (예: 9.5 -> 09:30)
  if (typeof timeValue === 'number' || !isNaN(parseFloat(timeValue))) {
    const hours = Math.floor(parseFloat(timeValue));
    const minutes = Math.round((parseFloat(timeValue) - hours) * 60);
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
  }
  
  // 문자열인 경우
  const timeStr = timeValue.toString();
  
  // 이미 HH:mm 형식인 경우
  if (/^\d{1,2}:\d{2}$/.test(timeStr)) {
    const [hours, minutes] = timeStr.split(':');
    return `${hours.padStart(2, '0')}:${minutes}`;
  }
  
  // HH.mm 형식인 경우 (예: 9.5 -> 09:30)
  if (/^\d+\.\d+$/.test(timeStr)) {
    const [hours, minutes] = timeStr.split('.');
    const minuteValue = Math.round(parseFloat(`0.${minutes}`) * 60);
    return `${hours.padStart(2, '0')}:${minuteValue.toString().padStart(2, '0')}`;
  }
  
  // 숫자만 있는 경우 (예: 930 -> 09:30)
  if (/^\d{3,4}$/.test(timeStr)) {
    const hours = Math.floor(parseInt(timeStr) / 100);
    const minutes = parseInt(timeStr) % 100;
    if (minutes < 60) {
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }
  }
  
  // 변환할 수 없는 경우 빈 문자열 반환
  console.warn(`시간 형식을 변환할 수 없습니다: ${timeValue}`);
  return '';
}

// 특정 날짜의 근태 데이터 조회
async function loadAttendanceData() {
  try {
    const date = document.getElementById('attendanceDate').value;
    
        // 현재 선택된 부서 정보 가져오기
        const departmentFilter = document.getElementById('departmentFilter');
        const selectedDepartment = departmentFilter ? departmentFilter.value : '';
        
        // 부서 정보를 포함하여 데이터 조회
        let url = `/attendance/data/${date}`;
        if (selectedDepartment) {
          url += `?department=${encodeURIComponent(selectedDepartment)}`;
        }
        
        const response = await fetch(url);
    const result = await response.json();
    
    if (result.success) {
          // 모든 필드를 먼저 초기화
          clearAllFields();
          
      // 기존 데이터로 폼 채우기
      const data = result.data;
          
      console.log('조회된 데이터:', data);
      
      for (const employeeId in data) {
        const attendance = data[employeeId];
            
        console.log(`직원 ${employeeId}의 근태 데이터:`, attendance);
        
        if (attendance.status) {
          // 상태 선택
          const statusSelect = document.querySelector(`select[name="${employeeId}_status"]`);
          if (statusSelect) {
            statusSelect.value = attendance.status;
                
            // 모든 상태에 대해 toggleTimeInputs 호출하여 기본값 설정
            toggleTimeInputs(employeeId);
                
            // 기존 데이터가 있는 경우 해당 값으로 설정 (시간 형식 변환 적용)
            if (attendance.checkIn) {
              const checkInInput = document.querySelector(`input[name="${employeeId}_checkIn"]`);
              if (checkInInput) {
                const formattedTime = formatTimeForInput(attendance.checkIn);
                checkInInput.value = formattedTime;
              }
            }
                
            if (attendance.checkOut) {
              const checkOutInput = document.querySelector(`input[name="${employeeId}_checkOut"]`);
              if (checkOutInput) {
                const formattedTime = formatTimeForInput(attendance.checkOut);
                checkOutInput.value = formattedTime;
              }
            }
                
            // 시간 입력 필드들 - MongoDB Map 타입 데이터 처리 (시간 형식 변환 적용)
            const timeFields = ['basic', 'overtime', 'special', 'specialOvertime', 'night'];
            timeFields.forEach(field => {
              const input = document.querySelector(`input[name="${employeeId}_${field}"]`);
              if (input && attendance[field] !== undefined && attendance[field] !== null && attendance[field] !== '') {
                const formattedTime = formatTimeForInput(attendance[field]);
                input.value = formattedTime;
              }
            });
                
            // 총시간 재계산
            calculateTotalTime(employeeId);
          }
          
              // 비고
          const noteInput = document.querySelector(`input[name="${employeeId}_note"]`);
              if (noteInput && attendance.note) {
                noteInput.value = attendance.note;
          }
        }
      }
      
      // 성공 메시지 표시
      const resultDiv = document.getElementById('saveResult');
      resultDiv.style.display = 'block';
      resultDiv.className = 'alert alert-info mt-3';
      resultDiv.innerHTML = `
        <i class="fa-solid fa-info-circle me-2"></i>
        ${date} 근태 데이터를 불러왔습니다.
      `;
      
      setTimeout(() => {
        resultDiv.style.display = 'none';
      }, 3000);
      
    } else {
      alert('근태 데이터 조회에 실패했습니다.');
    }
    
  } catch (error) {
    console.error('근태 데이터 조회 오류:', error);
    alert('근태 데이터 조회 중 오류가 발생했습니다.');
  }
}

    // 근태 자동 입력 함수
    async function autoSetAttendance() {
      try {
        const date = document.getElementById('attendanceDate').value;
        
        if (!date) {
          alert('날짜를 선택해주세요.');
          return;
        }
        
        if (!confirm('선택한 날짜의 근태를 자동으로 입력하시겠습니까?\n\n근무 스케줄에 따라 자동으로 설정됩니다.')) {
          return;
        }
        
        // 현재 선택된 부서 정보 가져오기
        const selectedDepartment = document.getElementById('departmentFilter').value;
        
        // 근태 자동 입력 API 호출
        const response = await fetch('/attendance/auto-attendance', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            date: date,
            department: selectedDepartment 
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // 성공 시 폼에 자동 입력된 데이터 적용
          applyAutoAttendanceData(result.data);
          
          // 성공 메시지 표시
          const resultDiv = document.getElementById('saveResult');
          resultDiv.style.display = 'block';
          resultDiv.className = 'alert alert-success mt-3';
          resultDiv.innerHTML = `
            <i class="fa-solid fa-check-circle me-2"></i>
            ${date} 근태가 자동으로 입력되었습니다.
          `;
          
          setTimeout(() => {
            resultDiv.style.display = 'none';
          }, 3000);
          
        } else {
          alert('근태 자동 입력에 실패했습니다: ' + result.message);
        }
        
      } catch (error) {
        console.error('근태 자동 입력 오류:', error);
        alert('근태 자동 입력 중 오류가 발생했습니다.');
      }
    }
    
    // 자동 입력된 근태 데이터를 폼에 적용
    function applyAutoAttendanceData(attendanceData) {
      console.log('자동입력 데이터 적용 시작:', attendanceData);
      
      // 현재 화면에 표시된 직원들의 ID 목록 가져오기
      const currentEmployeeIds = [];
      const statusSelects = document.querySelectorAll('select[name$="_status"]');
      console.log('찾은 상태 선택 요소들:', statusSelects.length, '개');
      
      statusSelects.forEach(select => {
        const name = select.getAttribute('name');
        const employeeId = name.replace('_status', '');
        currentEmployeeIds.push(employeeId);
        console.log(`상태 선택 요소: ${name} → 직원ID: ${employeeId}`);
      });
      
      console.log('현재 화면에 표시된 직원 ID들:', currentEmployeeIds);
      console.log('받은 자동입력 데이터 키들:', Object.keys(attendanceData));
      
      for (const employeeId in attendanceData) {
        // employeeId 유효성 검사 추가
        if (!employeeId || typeof employeeId !== 'string') {
          console.error('유효하지 않은 employeeId:', employeeId);
          continue;
        }
        
        const data = attendanceData[employeeId];
        console.log(`직원 ${employeeId} 데이터 적용:`, data);
        
        // 현재 화면에 표시된 직원만 처리
        if (!currentEmployeeIds.includes(employeeId)) {
          console.log(`직원 ${employeeId}는 현재 화면에 표시되지 않음, 건너뜀`);
          console.log(`화면 직원 ID들:`, currentEmployeeIds);
          console.log(`자동입력 데이터 키:`, employeeId);
          continue;
        }
        
        console.log(`✅ 직원 ${employeeId} 매칭 성공, 데이터 적용 시작`);
        
        // 상태 선택
        const statusSelect = document.querySelector(`select[name="${employeeId}_status"]`);
        console.log(`직원 ${employeeId} 상태 선택 요소 찾기:`, statusSelect);
        console.log(`적용할 데이터:`, data);
        
        if (statusSelect) {
          console.log(`상태 업데이트: ${statusSelect.value} → ${data.status}`);
          statusSelect.value = data.status;
          
          // 백엔드에서 설정한 값을 보존하기 위해 toggleTimeInputs 호출하지 않음
          // toggleTimeInputs(employeeId);
          
          // 입력 필드 활성화만 처리 (값은 변경하지 않음)
          const checkInInput = document.querySelector(`input[name="${employeeId}_checkIn"]`);
          const checkOutInput = document.querySelector(`input[name="${employeeId}_checkOut"]`);
          const timeInputs = document.querySelectorAll(`input[name^="${employeeId}_"][class*="time-input"]`);
          
          if (checkInInput) checkInInput.disabled = false;
          if (checkOutInput) checkOutInput.disabled = false;
          timeInputs.forEach(input => input.disabled = false);
          
          // 출근/퇴근 시간 설정
          if (data.checkIn) {
            const checkInInput = document.querySelector(`input[name="${employeeId}_checkIn"]`);
            if (checkInInput) checkInInput.value = data.checkIn;
          }
          
          if (data.checkOut) {
            const checkOutInput = document.querySelector(`input[name="${employeeId}_checkOut"]`);
            if (checkOutInput) checkOutInput.value = data.checkOut;
          }
          
          // 근무 시간 설정
          if (data.basic !== undefined) {
            const basicInput = document.querySelector(`input[name="${employeeId}_basic"]`);
            if (basicInput) basicInput.value = data.basic;
          }
          
          if (data.overtime !== undefined) {
            const overtimeInput = document.querySelector(`input[name="${employeeId}_overtime"]`);
            if (overtimeInput) overtimeInput.value = data.overtime;
          }
          
          if (data.special !== undefined) {
            const specialInput = document.querySelector(`input[name="${employeeId}_special"]`);
            if (specialInput) specialInput.value = data.special;
          }
          
          if (data.specialOvertime !== undefined) {
            const specialOvertimeInput = document.querySelector(`input[name="${employeeId}_specialOvertime"]`);
            if (specialOvertimeInput) specialOvertimeInput.value = data.specialOvertime;
          }
          
          if (data.night !== undefined) {
            const nightInput = document.querySelector(`input[name="${employeeId}_night"]`);
            if (nightInput) nightInput.value = data.night;
          }
          
          // 총시간 재계산
          calculateTotalTime(employeeId);
          
          // 야간시간 계산 - 자동입력 데이터가 있을 때는 실행하지 않음
          // if (data.checkIn && data.checkOut) {
          //   calculateNightTime(employeeId);
          // }
        }
        
        // 비고 설정
        if (data.note) {
          const noteInput = document.querySelector(`input[name="${employeeId}_note"]`);
          if (noteInput) noteInput.value = data.note;
        }
      }
    }
    
    // 날짜에 따른 요일 표시 함수
    function updateDayOfWeek() {
      const dateInput = document.getElementById('attendanceDate');
      const dayOfWeekSpan = document.getElementById('selectedDayOfWeek');
      
      if (dateInput.value) {
        const selectedDate = new Date(dateInput.value);
        const days = ['일', '월', '화', '수', '목', '금', '토'];
        const dayOfWeek = days[selectedDate.getDay()];
        
        // 주말인지 확인하여 색상 변경
        if (selectedDate.getDay() === 0 || selectedDate.getDay() === 6) {
          dayOfWeekSpan.className = 'badge bg-warning text-dark fs-6 px-3 py-2';
        } else {
          dayOfWeekSpan.className = 'badge bg-secondary fs-6 px-3 py-2';
        }
        
        dayOfWeekSpan.textContent = dayOfWeek;
      }
    }
    
    // 주차 번호 계산 (월요일 06시부터 다음주 월요일 06시까지) - 팀 근무 순환용
    function getWeekNumber(date) {
      // 2025년 1월 1일(수) 06:00을 기준으로 계산
      const yearStart = new Date(2025, 0, 1, 6, 0, 0); // 2025년 1월 1일 06:00
      const targetDate = new Date(date);
      
      // 월요일 06:00으로 조정
      const dayOfWeek = targetDate.getDay();
      const mondayOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
      
      const monday6am = new Date(targetDate);
      monday6am.setDate(targetDate.getDate() - mondayOffset);
      monday6am.setHours(6, 0, 0, 0);
      
      const weekDiff = Math.floor((monday6am - yearStart) / (7 * 24 * 60 * 60 * 1000));
      const weekNumber = weekDiff + 2; // 1월 1일 수요일이 1주차, 1월 6일 월요일이 2주차
      
      return weekNumber;
    }

    // 표시용 주차 번호 계산 (실제 주차)
    function getDisplayWeekNumber(date) {
      // 8월 26일과 8월 30일은 특별히 3주차로 설정 (1팀 심야, 2팀 주간, 3팀 초야)
      if ((date.getFullYear() === 2025 && date.getMonth() === 7 && date.getDate() === 26) ||
          (date.getFullYear() === 2025 && date.getMonth() === 7 && date.getDate() === 30)) {
        return 3;
      }
      
      // 실제 주차 계산 (보정값 없음)
      const yearStart = new Date(2025, 0, 1);
      const dayOfWeek = date.getDay();
      const mondayOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
      
      const monday6am = new Date(date);
      monday6am.setDate(date.getDate() - mondayOffset);
      monday6am.setHours(6, 0, 0, 0);
      
      const weekDiff = Math.floor((monday6am - yearStart) / (7 * 24 * 60 * 60 * 1000));
      return weekDiff + 1; // 1부터 시작하는 주차 번호
    }

    // 팀별 근무 형태 반환 함수 (올바른 패턴으로 수정)
    function getTeamSchedule(teamNumber, weekNumber) {
      // 3주 주기로 팀별 근무 형태 순환
      const cycle = (weekNumber - 1) % 3; // 0, 1, 2 반복
      
      if (teamNumber === 1) {
        // 1팀: 초야(cycle 0) → 주간(cycle 1) → 심야(cycle 2)
        const schedules = ['초야', '주간', '심야'];
        return schedules[cycle];
      } else if (teamNumber === 2) {
        // 2팀: 심야(cycle 0) → 초야(cycle 1) → 주간(cycle 2)
        const schedules = ['심야', '초야', '주간'];
        return schedules[cycle];
      } else if (teamNumber === 3) {
        // 3팀: 주간(cycle 0) → 심야(cycle 1) → 초야(cycle 2)
        const schedules = ['주간', '심야', '초야'];
        return schedules[cycle];
      }
      
      return '주간'; // 기본값
    }

    // 팀별 근무 형태를 선택된 날짜의 주차에 따라 동적으로 계산
    function updateTeamWorkSchedule() {
      const dateInput = document.getElementById('attendanceDate');
      const selectedDate = dateInput ? new Date(dateInput.value) : new Date();
      const weekNumber = getWeekNumber(selectedDate);
      
      // 주차별 팀 근무 순환 로직 (평일 기준)
      const team1Schedule = getTeamSchedule(1, weekNumber);
      const team2Schedule = getTeamSchedule(2, weekNumber);
      const team3Schedule = getTeamSchedule(3, weekNumber);
      
      console.log('=== 선택된 날짜의 근무형태 (주차별 순환) ===');
      console.log(`선택된 날짜: ${selectedDate.toISOString().split('T')[0]}`);
      console.log(`${weekNumber}주차 팀 근무 형태: 1팀=${team1Schedule}, 2팀=${team2Schedule}, 3팀=${team3Schedule}`);
      
      // 주차 정보 표시 업데이트
      const currentWeekInfo = document.getElementById('currentWeekInfo');
      if (currentWeekInfo) {
        const year = selectedDate.getFullYear();
        const month = selectedDate.getMonth() + 1;
        const day = selectedDate.getDate();
        const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
        const dayName = dayNames[selectedDate.getDay()];
        currentWeekInfo.textContent = `${year}년 ${month}월 ${day}일(${dayName}) - ${weekNumber}주차 팀 근무 형태`;
      }
      
      // UI 업데이트 - 팀 근무 형태
      document.getElementById('team1Schedule').textContent = team1Schedule;
      document.getElementById('team1Schedule').className = `badge ${getBadgeClass(team1Schedule)} fs-6`;
      
      document.getElementById('team2Schedule').textContent = team2Schedule;
      document.getElementById('team2Schedule').className = `badge ${getBadgeClass(team2Schedule)} fs-6`;
      
      document.getElementById('team3Schedule').textContent = team3Schedule;
      document.getElementById('team3Schedule').className = `badge ${getBadgeClass(team3Schedule)} fs-6`;
      
      // UI 업데이트 - 시간
      const team1TimeElement = document.querySelector('.col-md-4:nth-child(1) .d-block.text-muted.mt-1');
      const team2TimeElement = document.querySelector('.col-md-4:nth-child(2) .d-block.text-muted.mt-1');
      const team3TimeElement = document.querySelector('.col-md-4:nth-child(3) .d-block.text-muted.mt-1');
      
      if (team1TimeElement) {
        team1TimeElement.textContent = getTimeRange(team1Schedule);
      }
      if (team2TimeElement) {
        team2TimeElement.textContent = getTimeRange(team2Schedule);
      }
      if (team3TimeElement) {
        team3TimeElement.textContent = getTimeRange(team3Schedule);
      }
      
      // 근태상태 자동 설정
      updateAttendanceStatusBySchedule(team1Schedule, team2Schedule, team3Schedule);
    }
    
    // 팀 근무형태에 따라 근태상태 자동 설정
    function updateAttendanceStatusBySchedule(team1Schedule, team2Schedule, team3Schedule) {
      const dateInput = document.getElementById('attendanceDate');
      const selectedDate = dateInput ? new Date(dateInput.value) : new Date();
      const dayOfWeek = selectedDate.getDay(); // 0: 일요일, 1: 월요일, ..., 6: 토요일
      const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; // 토요일(6) 또는 일요일(0)
      
      const statusSelects = document.querySelectorAll('select[name$="_status"]');
      
      statusSelects.forEach(select => {
        const employeeId = select.name.replace('_status', '');
        const employeeRow = select.closest('tr');
        const departmentCell = employeeRow.querySelector('td:nth-child(2) .badge');
        
        if (departmentCell) {
          const department = departmentCell.textContent.trim();
          let expectedStatus = '';
          
          if (isWeekend) {
            // 주말 근무 로직
            if (department.includes('보안1팀')) {
              expectedStatus = '정기휴무'; // 주말에는 1팀 휴무
            } else if (department.includes('보안2팀')) {
              expectedStatus = '출근(주특)'; // 주말에는 2팀 주간특근
            } else if (department.includes('보안3팀')) {
              expectedStatus = '출근(야특)'; // 주말에는 3팀 야간특근
            } else {
              expectedStatus = '휴무'; // 보안팀이 아닌 경우 휴무
            }
          } else {
            // 평일 근무 로직
            if (department.includes('보안1팀')) {
              expectedStatus = getStatusBySchedule(team1Schedule);
            } else if (department.includes('보안2팀')) {
              expectedStatus = getStatusBySchedule(team2Schedule);
            } else if (department.includes('보안3팀')) {
              expectedStatus = getStatusBySchedule(team3Schedule);
            } else {
              expectedStatus = '출근(주)'; // 보안팀이 아닌 경우 평일 근무
            }
          }
          
          // 근태상태가 비어있거나 다른 상태인 경우에만 자동 설정
          if (select.value === '' || select.value !== expectedStatus) {
            select.value = expectedStatus;
            toggleTimeInputs(employeeId);
          }
        }
      });
    }
    
    // 근무형태에 따른 근태상태 반환
    function getStatusBySchedule(schedule) {
      switch(schedule) {
        case '주간': return '출근(주)';
        case '초야': return '출근(초)';
        case '심야': return '출근(심)';
        default: return '출근(주)';
      }
    }
    
    // 근무 형태에 따른 배지 클래스 반환
    function getBadgeClass(schedule) {
      switch(schedule) {
        case '주간': return 'bg-info';
        case '심야': return 'bg-warning';
        case '초야': return 'bg-success';
        default: return 'bg-secondary';
      }
    }
    
    // 근무 형태에 따른 시간 범위 반환
    function getTimeRange(schedule) {
      switch(schedule) {
        case '주간': return '06:00~14:00';
        case '심야': return '22:00~06:00';
        case '초야': return '14:00~22:00';
        default: return '00:00~00:00';
      }
    }
    
    // 날짜와 근무형태만 표시하는 형식
    function formatDetailedWeekDisplay(date, weekNumber) {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
      const dayName = dayNames[date.getDay()];
      
      return `${year}년 ${month}월 ${day}일(${dayName}요일)`;
    }

    // 페이지 로드 시 오늘 날짜 데이터 자동 조회 및 요일 표시
    document.addEventListener('DOMContentLoaded', function() {
      updateDayOfWeek(); // 초기 요일 표시
      updateTeamWorkSchedule(); // 팀 근무 형태 업데이트
      loadAttendanceData();
    });
    
    // 날짜 변경 시 요일 및 팀 근무형태 업데이트
    document.getElementById('attendanceDate').addEventListener('change', function() {
      updateDayOfWeek();
      updateTeamWorkSchedule();
    });


</script>

<%- include('footer') %>