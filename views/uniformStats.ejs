<!--
  파일명: uniformStats.ejs
  목적: 유니폼 통계 및 현황 관리 페이지
  기능:
  - 유니폼 종류별 통계 표시
  - 사이즈별 현황 차트
  - 부서별 유니폼 현황
  - 엑셀 다운로드 기능
  - 관리자 권한 검증
-->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>유니폼 통계 - 인사관리 시스템</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .stats-card {
      transition: transform 0.2s, box-shadow 0.2s;
      border: none;
      border-radius: 15px;
      height: 100%;
    }
    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }
    .uniform-type {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .size-stats {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }
    .department-stats {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }
    .btn-download {
      border-radius: 10px;
      font-weight: 600;
      padding: 12px 24px;
      transition: all 0.3s;
    }
    .btn-download:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .table-responsive {
      border-radius: 15px;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-light">
  <%- include('header') %>
  
  <div class="container mt-4">
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <h1 class="h2 mb-0">
            <i class="fa-solid fa-tshirt me-2 text-primary"></i>
            유니폼 통계
          </h1>
          <div>
            <button class="btn btn-success btn-download me-2" onclick="downloadUniformStats()">
              <i class="fa-solid fa-file-excel me-2"></i>엑셀 다운로드
            </button>
            <a href="/dashboard" class="btn btn-outline-secondary">
              <i class="fa-solid fa-arrow-left me-1"></i>대시보드
            </a>
          </div>
        </div>
        <p class="text-muted mt-2">유니폼 현황 및 통계를 확인하고 관리할 수 있습니다.</p>
      </div>
    </div>

    <!-- 통계 요약 카드 -->
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card stats-card uniform-type">
          <div class="card-body text-center">
            <i class="fa-solid fa-tshirt fa-3x mb-3"></i>
            <h3 class="card-title" id="totalUniforms">0</h3>
            <p class="card-text mb-0">총 유니폼 수</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card size-stats">
          <div class="card-body text-center">
            <i class="fa-solid fa-ruler fa-3x mb-3"></i>
            <h3 class="card-title" id="totalSizes">0</h3>
            <p class="card-text mb-0">사이즈 종류</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card department-stats">
          <div class="card-body text-center">
            <i class="fa-solid fa-building fa-3x mb-3"></i>
            <h3 class="card-title" id="totalDepartments">0</h3>
            <p class="card-text mb-0">부서 수</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card bg-warning text-white">
          <div class="card-body text-center">
            <i class="fa-solid fa-exclamation-triangle fa-3x mb-3"></i>
            <h3 class="card-title" id="lowStock">0</h3>
            <p class="card-text mb-0">재고 부족</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 차트 및 상세 통계 -->
    <div class="row g-4">
      <!-- 유니폼 종류별 통계 -->
      <div class="col-lg-6">
        <div class="card stats-card h-100">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              <i class="fa-solid fa-chart-pie me-2"></i>
              유니폼 종류별 현황
            </h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="uniformTypeChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- 사이즈별 통계 -->
      <div class="col-lg-6">
        <div class="card stats-card h-100">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">
              <i class="fa-solid fa-chart-bar me-2"></i>
              사이즈별 현황
            </h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="sizeChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 상세 통계 테이블 -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card stats-card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">
              <i class="fa-solid fa-table me-2"></i>
              부서별 유니폼 상세 현황
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="uniformTable">
                <thead class="table-dark">
                  <tr>
                    <th>부서</th>
                    <th>유니폼 종류</th>
                    <th>사이즈</th>
                    <th>수량</th>
                    <th>재고 상태</th>
                    <th>마지막 업데이트</th>
                  </tr>
                </thead>
                <tbody id="uniformTableBody">
                  <!-- 데이터가 동적으로 로드됨 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('footer') %>

  <script>
    // 차트 객체들
    let uniformTypeChart, sizeChart;

    // 페이지 로드 시 데이터 로드
    document.addEventListener('DOMContentLoaded', function() {
      loadUniformStats();
    });

    // 유니폼 통계 데이터 로드
    async function loadUniformStats() {
      try {
        const response = await fetch('/uniform/stats');
        const result = await response.json();
        
        if (result.success) {
          const stats = result.data;
          updateSummaryCards(stats);
          createCharts(stats);
          updateUniformTable(stats);
        } else {
          console.error('통계 데이터 로드 실패:', result.message);
        }
      } catch (error) {
        console.error('통계 데이터 로드 오류:', error);
      }
    }

    // 요약 카드 업데이트
    function updateSummaryCards(stats) {
      document.getElementById('totalUniforms').textContent = stats.totalUniforms || 0;
      document.getElementById('totalSizes').textContent = stats.totalSizes || 0;
      document.getElementById('totalDepartments').textContent = stats.totalDepartments || 0;
      document.getElementById('lowStock').textContent = stats.lowStock || 0;
    }

    // 차트 생성
    function createCharts(stats) {
      // 유니폼 종류별 차트
      const uniformTypeCtx = document.getElementById('uniformTypeChart').getContext('2d');
      uniformTypeChart = new Chart(uniformTypeCtx, {
        type: 'doughnut',
        data: {
          labels: stats.uniformTypes?.map(item => item.name) || [],
          datasets: [{
            data: stats.uniformTypes?.map(item => item.count) || [],
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
              '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // 사이즈별 차트
      const sizeCtx = document.getElementById('sizeChart').getContext('2d');
      sizeChart = new Chart(sizeCtx, {
        type: 'bar',
        data: {
          labels: stats.sizes?.map(item => item.size) || [],
          datasets: [{
            label: '수량',
            data: stats.sizes?.map(item => item.count) || [],
            backgroundColor: 'rgba(54, 162, 235, 0.8)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // 유니폼 테이블 업데이트
    function updateUniformTable(stats) {
      const tbody = document.getElementById('uniformTableBody');
      tbody.innerHTML = '';

      if (stats.departments) {
        stats.departments.forEach(dept => {
          dept.uniforms.forEach(uniform => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${dept.name}</td>
              <td>${uniform.type}</td>
              <td>${uniform.size}</td>
              <td>${uniform.quantity}</td>
              <td>
                <span class="badge ${uniform.quantity < 10 ? 'bg-danger' : uniform.quantity < 30 ? 'bg-warning' : 'bg-success'}">
                  ${uniform.quantity < 10 ? '재고 부족' : uniform.quantity < 30 ? '재고 적음' : '재고 충분'}
                </span>
              </td>
              <td>${new Date(uniform.lastUpdated).toLocaleDateString('ko-KR')}</td>
            `;
            tbody.appendChild(row);
          });
        });
      }
    }

    // 엑셀 다운로드
    function downloadUniformStats() {
      window.location.href = '/uniform/stats/excel';
    }

    // 차트 리사이즈 처리
    window.addEventListener('resize', function() {
      if (uniformTypeChart) uniformTypeChart.resize();
      if (sizeChart) sizeChart.resize();
    });
  </script>
</body>
</html>
