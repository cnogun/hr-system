<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - 인사관리 시스템</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e2eafc 100%);
      min-height: 100vh;
    }
    .container-fluid {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 15px;
    }
    .detail-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
      height: fit-content;
    }
    .priority-high { 
      border-left: 4px solid #dc3545; 
      background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
    }
    .priority-medium { 
      border-left: 4px solid #ffc107; 
      background: linear-gradient(135deg, #fffbf0 0%, #fef3c7 100%);
    }
    .priority-low { 
      border-left: 4px solid #28a745; 
      background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
    }
    .status-badge {
      font-size: 0.875rem;
      padding: 0.375rem 0.75rem;
      border-radius: 0.5rem;
    }
    .status-pending { background-color: #6c757d; color: white; }
    .status-active { background-color: #007bff; color: white; }
    .status-completed { background-color: #28a745; color: white; }
    
    
    .info-item {
      display: flex;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    .info-item i {
      width: 20px;
      margin-right: 0.5rem;
      color: #6c757d;
    }
    .attachment-item {
      display: flex;
      align-items: center;
      justify-content: between;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
    }
    .progress-section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
      height: fit-content;
    }
    .action-buttons {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      height: fit-content;
    }
    
    /* 목록 버튼 회색 배경 스타일 */
    .btn-secondary {
      background-color: #6c757d !important;
      border-color: #6c757d !important;
      color: white !important;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268 !important;
      border-color: #545b62 !important;
      color: white !important;
    }
    
    /* 반응형 레이아웃 최적화 */
    @media (max-width: 1200px) {
      .col-xl-9 {
        margin-bottom: 1rem;
      }
      .col-xl-3 {
        margin-top: 0;
      }
    }
    
    @media (max-width: 768px) {
      .detail-card {
        padding: 1rem;
        margin-bottom: 1rem;
      }
      .progress-section,
      .action-buttons {
        padding: 1rem;
        margin-bottom: 1rem;
      }
    }
    
    /* 브레드크럼 중앙 정렬 */
    .breadcrumb.justify-content-center {
      display: flex;
      justify-content: center;
    }
    
    /* 인쇄 스타일 */
    @media print {
      .action-buttons,
      .btn,
      nav,
      .breadcrumb,
      .navbar,
      .footer {
        display: none !important;
      }
      
      .container {
        max-width: none !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      .detail-card {
        box-shadow: none !important;
        border: 1px solid #ddd !important;
        margin-bottom: 1rem !important;
        page-break-inside: avoid;
      }
      
      .card-body {
        padding: 1rem !important;
      }
      
      h2, h3, h4, h5, h6 {
        color: #000 !important;
      }
      
      .text-muted {
        color: #666 !important;
      }
    }
  </style>
</head>
<body>
  <%- include('../header') %>
  
  <div class="container-fluid mt-4 flex-grow-1">
    <div class="row">
      <div class="col-12">

        <!-- 제목 중앙 정렬 -->
        <div class="text-center mb-4">
          <h2 class="mb-2">
            <i class="fas fa-file-alt text-primary me-2"></i>근무명령서 상세
          </h2>
          <nav aria-label="breadcrumb" class="justify-content-center">
            <ol class="breadcrumb justify-content-center">
              <li class="breadcrumb-item"><a href="/security/work-orders">근무명령서</a></li>
              <li class="breadcrumb-item active">상세보기</li>
            </ol>
          </nav>
        </div>
        
        <!-- 우측 상단 버튼들 -->
        <div class="d-flex justify-content-end mb-4">
          <div class="d-flex gap-2">
            <a href="/security/work-orders" class="btn btn-secondary">
              <i class="fas fa-list me-1"></i>목록
            </a>
            <button class="btn btn-info" onclick="printWorkOrder()">
              <i class="fas fa-print me-1"></i>인쇄
            </button>
            <% if (workOrder.status !== 'completed') { %>
              <button class="btn btn-success" onclick="completeOrder()">
                <i class="fas fa-check me-1"></i>완료처리
              </button>
            <% } %>
            <% if (workOrder.status === 'active') { %>
              <button class="btn btn-warning" onclick="updateProgress()">
                <i class="fas fa-edit me-1"></i>진행률 수정
              </button>
            <% } %>
          </div>
        </div>

        <!-- 메시지 표시 -->
        <% if (message) { %>
          <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fas fa-info-circle me-2"></i><%= message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% } %>

        <div class="row g-3">
          <!-- 메인 정보 -->
          <div class="col-xl-9 col-lg-8">
            <!-- 기본 정보 -->
            <div class="detail-card priority-<%= workOrder.priority %>">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h4 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i><%= workOrder.title %>
                  </h4>
                  <span class="status-badge status-<%= workOrder.status %>">
                    <% if (workOrder.status === 'pending') { %>대기중
                    <% } else if (workOrder.status === 'active') { %>진행중
                    <% } else if (workOrder.status === 'completed') { %>완료<% } %>
                  </span>
                </div>
                
                <div class="row">
                  <div class="col-md-6">
                    <div class="info-item">
                      <i class="fas fa-building"></i>
                      <strong>담당 부서:</strong> <%= workOrder.department %>
                    </div>
                    <div class="info-item">
                      <i class="fas fa-exclamation-triangle"></i>
                      <strong>우선순위:</strong> 
                      <% if (workOrder.priority === 'high') { %>긴급
                      <% } else if (workOrder.priority === 'medium') { %>보통
                      <% } else if (workOrder.priority === 'low') { %>낮음<% } %>
                    </div>
                    <div class="info-item">
                      <i class="fas fa-user"></i>
                      <strong>등록자:</strong> <%= workOrder.createdBy ? workOrder.createdBy.name : '알 수 없음' %>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="info-item">
                      <i class="fas fa-calendar"></i>
                      <strong>등록일:</strong> <%= new Date(workOrder.createdAt).toLocaleDateString('ko-KR') %>
                    </div>
                    <% if (workOrder.deadline) { %>
                      <div class="info-item">
                        <i class="fas fa-clock"></i>
                        <strong>마감일:</strong> <%= new Date(workOrder.deadline).toLocaleDateString('ko-KR') %>
                      </div>
                    <% } %>
                    <div class="info-item">
                      <i class="fas fa-edit"></i>
                      <strong>수정일:</strong> <%= new Date(workOrder.updatedAt).toLocaleDateString('ko-KR') %>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 내용 -->
            <div class="detail-card">
              <div class="card-body">
                <h5 class="card-title">
                  <i class="fas fa-align-left me-2"></i>내용
                </h5>
                <div class="content-text">
                  <%= workOrder.content.replace(/\n/g, '<br>') %>
                </div>
              </div>
            </div>

            <!-- 사고내용 -->
            <% if (workOrder.personnelStatus && workOrder.personnelStatus.absentDetails && workOrder.personnelStatus.absentDetails.length > 0) { %>
              <div class="detail-card">
                <div class="card-body">
                  <h5 class="card-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>사고내용
                  </h5>
                  <div class="accident-content" style="text-align: left;">
                    <%
                      // 사고내용을 원하는 순서로 정렬
                      const absentDetails = workOrder.personnelStatus.absentDetails;
                      const sortedDetails = [];
                      
                      // 정렬 순서 정의
                      const sortOrder = ['연차1', '연차2', '기타', '정직', '병가', '산재', '휴직', '경조', '결근', '근무지원조'];
                      
                      // 각 순서에 따라 정렬
                      sortOrder.forEach(type => {
                        const items = absentDetails.filter(item => item.type === type);
                        sortedDetails.push(...items);
                      });
                      
                      // 순서에 없는 타입들 추가
                      absentDetails.forEach(item => {
                        if (!sortOrder.includes(item.type)) {
                          sortedDetails.push(item);
                        }
                      });
                    %>
                    <% sortedDetails.forEach((detail, index) => { %>
                      <div style="margin-bottom: 5px; text-align: left !important; display: block !important;">
                        <%= detail.type %>: <%= detail.employeeName %>
                      </div>
                    <% }); %>
                  </div>
                </div>
              </div>
            <% } %>

            <!-- 담당자 -->
            <% if (workOrder.assignedTo && workOrder.assignedTo.length > 0) { %>
              <div class="detail-card">
                <div class="card-body">
                  <h5 class="card-title">
                    <i class="fas fa-users me-2"></i>담당자
                  </h5>
                  <div class="row">
                    <% workOrder.assignedTo.forEach(user => { %>
                      <div class="col-md-6 mb-2">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-user-circle me-2 text-primary"></i>
                          <span><%= user.name || user.username || user %></span>
                        </div>
                      </div>
                    <% }); %>
                  </div>
                </div>
              </div>
            <% } %>

            <!-- 첨부파일 -->
            <% if (workOrder.attachments && workOrder.attachments.length > 0) { %>
              <div class="detail-card">
                <div class="card-body">
                  <h5 class="card-title">
                    <i class="fas fa-paperclip me-2"></i>첨부파일
                  </h5>
                  <% workOrder.attachments.forEach(attachment => { %>
                    <div class="attachment-item">
                      <div class="d-flex align-items-center flex-grow-1">
                        <i class="fas fa-file me-2 text-muted"></i>
                        <div>
                          <div class="fw-bold"><%= attachment.originalName %></div>
                          <small class="text-muted">
                            <%= (attachment.fileSize / 1024).toFixed(1) %> KB
                          </small>
                        </div>
                      </div>
                      <a href="/security/attachments/<%= attachment.fileName %>" 
                         class="btn btn-sm btn-outline-primary" 
                         download="<%= attachment.originalName %>">
                        <i class="fas fa-download me-1"></i>다운로드
                      </a>
                    </div>
                  <% }); %>
                </div>
              </div>
            <% } %>
          </div>

          <!-- 사이드바 -->
          <div class="col-xl-3 col-lg-4">
            <!-- 진행률 -->
            <div class="progress-section">
              <h5 class="mb-3">
                <i class="fas fa-chart-line me-2"></i>진행률
              </h5>
              <div class="progress mb-3" style="height: 20px;">
                <div class="progress-bar 
                  <% if (workOrder.progress < 30) { %>bg-danger
                  <% } else if (workOrder.progress < 70) { %>bg-warning
                  <% } else { %>bg-success<% } %>" 
                  role="progressbar" 
                  style="width: <%= workOrder.progress %>%" 
                  aria-valuenow="<%= workOrder.progress %>" 
                  aria-valuemin="0" 
                  aria-valuemax="100">
                  <%= workOrder.progress %>%
                </div>
              </div>
              <div class="text-center">
                <% if (workOrder.status === 'pending') { %>
                  <span class="badge bg-secondary">대기중</span>
                <% } else if (workOrder.status === 'active') { %>
                  <span class="badge bg-primary">진행중</span>
                <% } else if (workOrder.status === 'completed') { %>
                  <span class="badge bg-success">완료</span>
                <% } %>
              </div>
            </div>

            <!-- 액션 버튼 -->
            <div class="action-buttons">
              <h5 class="mb-3">
                <i class="fas fa-cogs me-2"></i>작업
              </h5>
              <div class="d-grid gap-2">
                <% if (workOrder.status === 'pending') { %>
                  <button class="btn btn-primary" onclick="updateStatus('active')">
                    <i class="fas fa-play me-1"></i>시작하기
                  </button>
                <% } else if (workOrder.status === 'active') { %>
                  <button class="btn btn-warning" onclick="updateProgress()">
                    <i class="fas fa-edit me-1"></i>진행률 수정
                  </button>
                <% } %>
                
              </div>
            </div>

            <!-- 메타 정보 -->
            <div class="detail-card">
              <div class="card-body">
                <h5 class="card-title">
                  <i class="fas fa-info-circle me-2"></i>메타 정보
                </h5>
                <div class="info-item">
                  <i class="fas fa-hashtag"></i>
                  <strong>ID:</strong> <%= workOrder._id %>
                </div>
                <div class="info-item">
                  <i class="fas fa-calendar-plus"></i>
                  <strong>생성일:</strong> <%= new Date(workOrder.createdAt).toLocaleString('ko-KR') %>
                </div>
                <div class="info-item">
                  <i class="fas fa-calendar-edit"></i>
                  <strong>수정일:</strong> <%= new Date(workOrder.updatedAt).toLocaleString('ko-KR') %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 진행률 수정 모달 -->
  <div class="modal fade" id="progressModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">진행률 수정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">진행률 (%)</label>
            <input type="range" class="form-range" id="progressRange" min="0" max="100" value="<%= workOrder.progress %>">
            <div class="d-flex justify-content-between">
              <span>0%</span>
              <span id="progressValue"><%= workOrder.progress %>%</span>
              <span>100%</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" onclick="saveProgress()">저장</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>


      // 진행률 슬라이더 이벤트
      const progressRange = document.getElementById('progressRange');
      const progressValue = document.getElementById('progressValue');
      
      if (progressRange && progressValue) {
        progressRange.addEventListener('input', function() {
          progressValue.textContent = this.value + '%';
        });
      }
    });

    // 상태 업데이트
    async function updateStatus(status) {
      try {
        const response = await fetch(`/security/api/work-orders/<%= workOrder._id %>/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: status })
        });
        
        if (response.ok) {
          location.reload();
        } else {
          alert('상태 업데이트에 실패했습니다.');
        }
      } catch (error) {
        console.error('상태 업데이트 오류:', error);
        alert('상태 업데이트 중 오류가 발생했습니다.');
      }
    }

    // 진행률 수정 모달 열기
    function updateProgress() {
      const modal = new bootstrap.Modal(document.getElementById('progressModal'));
      modal.show();
    }

    // 진행률 저장
    async function saveProgress() {
      const progress = document.getElementById('progressRange').value;
      
      try {
        const response = await fetch(`/security/api/work-orders/<%= workOrder._id %>/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ progress: parseInt(progress) })
        });
        
        if (response.ok) {
          location.reload();
        } else {
          alert('진행률 업데이트에 실패했습니다.');
        }
      } catch (error) {
        console.error('진행률 업데이트 오류:', error);
        alert('진행률 업데이트 중 오류가 발생했습니다.');
      }
    }

    // 완료 처리
    async function completeOrder() {
      if (!confirm('이 근무명령서를 완료 처리하시겠습니까?')) return;
      
      try {
        const response = await fetch(`/security/api/work-orders/<%= workOrder._id %>/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: 'completed', progress: 100 })
        });
        
        if (response.ok) {
          location.reload();
        } else {
          alert('완료 처리에 실패했습니다.');
        }
      } catch (error) {
        console.error('완료 처리 오류:', error);
        alert('완료 처리 중 오류가 발생했습니다.');
      }
    }

    // 인쇄 기능
    function printWorkOrder() {
      // 인쇄 시 불필요한 요소들 숨기기
      const elementsToHide = [
        '.action-buttons',
        '.btn',
        'nav',
        '.breadcrumb'
      ];
      
      // 요소들 숨기기
      elementsToHide.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
          el.style.display = 'none';
        });
      });
      
      // 인쇄 실행
      window.print();
      
      // 인쇄 후 요소들 다시 보이기
      elementsToHide.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
          el.style.display = '';
        });
      });
    }
  </script>
</body>
</html>
