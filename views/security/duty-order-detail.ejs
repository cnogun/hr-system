<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>근무명령서 상세 - 인사관리 시스템</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    .priority-high { border-left: 4px solid #dc3545; }
    .priority-medium { border-left: 4px solid #ffc107; }
    .priority-low { border-left: 4px solid #28a745; }
    .status-pending { background-color: #fff3cd; }
    .status-active { background-color: #d1ecf1; }
    .status-completed { background-color: #d4edda; }
    .progress-bar-custom {
      height: 12px;
      border-radius: 6px;
    }
    .comment-section {
      background-color: #f8f9fa;
      border-radius: 0.5rem;
      padding: 1rem;
    }
    .comment-item {
      border-bottom: 1px solid #dee2e6;
      padding: 0.75rem 0;
    }
    .comment-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <%- include('../header') %>
  
  <div class="container mt-4">
    <div class="row">
      <div class="col-12">
        <!-- 헤더 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <a href="/security/duty-orders" class="btn btn-outline-secondary btn-sm mb-2">
              <i class="fas fa-arrow-left me-1"></i>목록으로
            </a>
            <h2 class="mb-0">
              <i class="fas fa-clipboard-list text-primary me-2"></i>근무명령서 상세
            </h2>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="editDutyOrder()">
              <i class="fas fa-edit me-1"></i>수정
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteDutyOrder()">
              <i class="fas fa-trash me-1"></i>삭제
            </button>
          </div>
        </div>

        <!-- 근무명령서 정보 -->
        <div class="card priority-<%= dutyOrder.priority %> mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h4 class="mb-0"><%= dutyOrder.title %></h4>
              <div class="d-flex gap-2">
                <span class="badge bg-<%= dutyOrder.priority === 'high' ? 'danger' : dutyOrder.priority === 'medium' ? 'warning' : 'success' %> fs-6">
                  <%= dutyOrder.priority === 'high' ? '긴급' : dutyOrder.priority === 'medium' ? '보통' : '낮음' %>
                </span>
                <span class="badge bg-<%= dutyOrder.status === 'pending' ? 'warning' : dutyOrder.status === 'active' ? 'info' : 'success' %> fs-6">
                  <%= dutyOrder.status === 'pending' ? '대기중' : dutyOrder.status === 'active' ? '진행중' : '완료' %>
                </span>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="row mb-4">
              <div class="col-md-6">
                <h6 class="text-muted">담당 부서</h6>
                <p class="mb-3"><%= dutyOrder.department %></p>
                
                <h6 class="text-muted">발령자</h6>
                <p class="mb-3"><%= dutyOrder.issuedBy ? dutyOrder.issuedBy.name : '알 수 없음' %></p>
                
                <h6 class="text-muted">발령일</h6>
                <p class="mb-3"><%= new Date(dutyOrder.createdAt).toLocaleDateString('ko-KR') %></p>
              </div>
              <div class="col-md-6">
                <h6 class="text-muted">마감일</h6>
                <p class="mb-3">
                  <% if (dutyOrder.deadline) { %>
                    <%= new Date(dutyOrder.deadline).toLocaleDateString('ko-KR') %>
                  <% } else { %>
                    설정되지 않음
                  <% } %>
                </p>
                
                <h6 class="text-muted">진행률</h6>
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span><%= dutyOrder.progress || 0 %>%</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="updateProgress()">진행률 수정</button>
                  </div>
                  <div class="progress progress-bar-custom">
                    <div class="progress-bar bg-<%= dutyOrder.progress >= 100 ? 'success' : dutyOrder.progress >= 50 ? 'warning' : 'info' %>" 
                         style="width: <%= (dutyOrder.progress || 0) %>%"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <h6 class="text-muted">명령 내용</h6>
            <div class="border rounded p-3 mb-4" style="background-color: #f8f9fa;">
              <p class="mb-0"><%= dutyOrder.content %></p>
            </div>
          </div>
        </div>

        <!-- 담당자 및 할당 정보 -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>담당자 정보</h5>
          </div>
          <div class="card-body">
            <% if (dutyOrder.assignedTo && dutyOrder.assignedTo.length > 0) { %>
              <div class="row">
                <% dutyOrder.assignedTo.forEach(employee => { %>
                  <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-center">
                      <i class="fas fa-user-circle text-primary me-2"></i>
                      <div>
                        <strong><%= employee.name %></strong>
                        <br><small class="text-muted"><%= employee.department %></small>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            <% } else { %>
              <p class="text-muted mb-0">담당자가 지정되지 않았습니다.</p>
            <% } %>
          </div>
        </div>

        <!-- 첨부파일 -->
        <% if (dutyOrder.attachments && dutyOrder.attachments.length > 0) { %>
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-paperclip me-2"></i>첨부파일</h5>
            </div>
            <div class="card-body">
              <div class="list-group">
                <% dutyOrder.attachments.forEach(file => { %>
                  <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <i class="fas fa-file me-2"></i>
                      <%= file.filename %>
                      <small class="text-muted ms-2">
                        (<%= new Date(file.uploadedAt).toLocaleDateString('ko-KR') %>)
                      </small>
                    </div>
                    <div>
                      <a href="/security/download/<%= file.filename %>" class="btn btn-sm btn-outline-primary me-2">
                        <i class="fas fa-download me-1"></i>다운로드
                      </a>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteFile('<%= file.filename %>')">
                        <i class="fas fa-trash me-1"></i>삭제
                      </button>
                    </div>
                  </div>
                <% }); %>
              </div>
            </div>
          </div>
        <% } %>

        <!-- 댓글 섹션 -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-comments me-2"></i>댓글</h5>
          </div>
          <div class="card-body">
            <!-- 새 댓글 작성 -->
            <form id="commentForm" class="mb-4">
              <div class="mb-3">
                <textarea class="form-control" id="commentContent" rows="3" placeholder="댓글을 입력하세요..." required></textarea>
              </div>
              <button type="submit" class="btn btn-primary btn-sm">
                <i class="fas fa-paper-plane me-1"></i>댓글 작성
              </button>
            </form>
            
            <!-- 댓글 목록 -->
            <div class="comment-section">
              <% if (dutyOrder.comments && dutyOrder.comments.length > 0) { %>
                <% dutyOrder.comments.forEach(comment => { %>
                  <div class="comment-item">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <strong><%= comment.user ? comment.user.name : '알 수 없음' %></strong>
                        <small class="text-muted ms-2"><%= new Date(comment.createdAt).toLocaleString('ko-KR') %></small>
                      </div>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteComment('<%= comment._id %>')">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                    <p class="mb-0 mt-2"><%= comment.content %></p>
                  </div>
                <% }); %>
              <% } else { %>
                <p class="text-muted text-center mb-0">등록된 댓글이 없습니다.</p>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 진행률 수정 모달 -->
  <div class="modal fade" id="progressModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">진행률 수정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">진행률 (%)</label>
            <input type="range" class="form-range" id="progressRange" min="0" max="100" value="<%= dutyOrder.progress || 0 %>">
            <div class="text-center mt-2">
              <span id="progressValue" class="h4"><%= dutyOrder.progress || 0 %>%</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" onclick="saveProgress()">저장</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 진행률 수정 모달 열기
    function updateProgress() {
      const modal = new bootstrap.Modal(document.getElementById('progressModal'));
      modal.show();
    }

    // 진행률 슬라이더 값 업데이트
    document.getElementById('progressRange').addEventListener('input', function() {
      document.getElementById('progressValue').textContent = this.value + '%';
    });

    // 진행률 저장
    async function saveProgress() {
      const progress = document.getElementById('progressRange').value;
      
      try {
        const response = await fetch(`/security/api/duty-orders/<%= dutyOrder._id %>/progress`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ progress: parseInt(progress) })
        });
        
        if (response.ok) {
          location.reload();
        } else {
          alert('진행률 업데이트에 실패했습니다.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('진행률 업데이트 중 오류가 발생했습니다.');
      }
    }

    // 댓글 작성
    document.getElementById('commentForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const content = document.getElementById('commentContent').value;
      if (!content.trim()) return;
      
      try {
        const response = await fetch(`/security/api/duty-orders/<%= dutyOrder._id %>/comments`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ content })
        });
        
        if (response.ok) {
          location.reload();
        } else {
          alert('댓글 작성에 실패했습니다.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('댓글 작성 중 오류가 발생했습니다.');
      }
    });

    // 댓글 삭제
    async function deleteComment(commentId) {
      if (!confirm('댓글을 삭제하시겠습니까?')) return;
      
      try {
        const response = await fetch(`/security/api/duty-orders/<%= dutyOrder._id %>/comments/${commentId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          location.reload();
        } else {
          alert('댓글 삭제에 실패했습니다.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('댓글 삭제 중 오류가 발생했습니다.');
      }
    }

    // 근무명령서 수정
    function editDutyOrder() {
      // 수정 페이지로 이동하는 로직 구현
      alert('수정 기능은 추후 구현 예정입니다.');
    }

    // 근무명령서 삭제
    function deleteDutyOrder() {
      if (!confirm('근무명령서를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
      
      // 삭제 로직 구현
      alert('삭제 기능은 추후 구현 예정입니다.');
    }
    
    // 파일 삭제 함수
    async function deleteFile(filename) {
      if (!confirm('파일을 삭제하시겠습니까?')) {
        return;
      }
      
      try {
        const response = await fetch(`/security/files/${filename}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('파일이 삭제되었습니다.');
          location.reload(); // 페이지 새로고침
        } else {
          alert('파일 삭제에 실패했습니다: ' + result.message);
        }
      } catch (error) {
        console.error('파일 삭제 오류:', error);
        alert('파일 삭제 중 오류가 발생했습니다.');
      }
    }
  </script>
</body>
</html>
